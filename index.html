import { useState, useRef, useCallback, useEffect } from "react";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMAZON BRAND STORE BUILDER â€” MULTI-STEP AI GENERATION
   5 sequential API calls, each focused on one job.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Real Amazon Store Tile Types & Specs â”€â”€
const TILES = {
  hero_image:     { name:"Hero Image", icon:"ğŸ–¼ï¸", grp:"Header", sizes:["full_width"], needsImage:true,
    specs:{ full_width:{ min:"3000Ã—600px", rec:"3000Ã—1200px", max:"5MB", safe:"Mittlere 70%", fmt:"JPG/PNG" }}},
  image:          { name:"Image", icon:"ğŸ–¼ï¸", grp:"Content", sizes:["full_width","large","medium","small"], needsImage:true,
    specs:{ full_width:{min:"1500Ã—20px",rec:"3000px Breite",max:"5MB"}, large:{min:"1500Ã—1500px"}, medium:{min:"1500Ã—750px"}, small:{min:"750Ã—750px"}}},
  image_with_text:{ name:"Image + Text", icon:"ğŸ“ğŸ–¼ï¸", grp:"Content", sizes:["full_width","large","medium","small"], needsImage:true,
    specs:{ full_width:{min:"3000Ã—1500px (Overlay) / 1500Ã—1500px (Beside)",max:"5MB"}, large:{min:"1500Ã—1500px"}, medium:{min:"1500Ã—750px / 750Ã—750px"}, small:{min:"750Ã—750px"}}},
  shoppable_image:{ name:"Shoppable Image", icon:"ğŸ›’", grp:"Content", sizes:["full_width","large","medium","small"], needsImage:true,
    specs:{ full_width:{min:"1500Ã—750px",rec:"3000Ã—1500px",max:"5MB",note:"Bis zu 6 Produkt-Hotspots"}}},
  text:           { name:"Text", icon:"ğŸ“", grp:"Content", sizes:["full_width","large","medium","small"], needsImage:false },
  video:          { name:"Video", icon:"ğŸ¥", grp:"Media", sizes:["full_width","large","medium"], needsImage:true,
    specs:{ full_width:{cover:"3000Ã—1500px",video:"1280Ã—640px",ratio:"6:4â€“8:3",fmt:"MP4 H.264"}}},
  background_video:{ name:"Background Video", icon:"ğŸ¬", grp:"Media", sizes:["full_width","large","medium"], needsImage:false,
    specs:{ full_width:{video:"1280Ã—640px",dur:"2â€“20s",note:"Auto-play, stumm, max 4/Seite"}}},
  gallery:        { name:"Gallery", icon:"ğŸ¨", grp:"Content", sizes:["full_width"], needsImage:true,
    specs:{ full_width:{min:"1500Ã—750px",count:"3â€“8 Bilder",note:"Alle gleiche GrÃ¶ÃŸe"}}},
  product:        { name:"Product", icon:"ğŸ“¦", grp:"Produkte", sizes:["full_width","large","medium","small"], needsImage:false },
  product_grid:   { name:"Product Grid", icon:"ğŸ›ï¸", grp:"Produkte", sizes:["full_width"], needsImage:false,
    specs:{ full_width:{note:"4â€“500 Produkte, Standard oder Tall, max 1/Seite"}}},
  best_sellers:   { name:"Best Sellers", icon:"ğŸ†", grp:"Produkte", sizes:["full_width"], needsImage:false },
  recommended:    { name:"Recommended", icon:"ğŸ’¡", grp:"Produkte", sizes:["full_width"], needsImage:false },
  featured_deals: { name:"Featured Deals", icon:"ğŸ·ï¸", grp:"Produkte", sizes:["full_width"], needsImage:false },
};

const SIZE_LABELS = { full_width:"Full Width", large:"Large", medium:"Medium", small:"Small" };
const GROUPS = ["Header","Content","Media","Produkte"];

// â”€â”€ Helpers â”€â”€
const uid = () => `${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
const mkTile = (type,size="full_width",content={},briefing="") => ({
  id:uid(), type, size: TILES[type]?.sizes.includes(size)?size:(TILES[type]?.sizes[0]||"full_width"),
  content, imageBriefing:briefing, image:null, imageFile:"", imgW:0, imgH:0
});
const mkPage = (name,id) => ({ id:id||uid(), name, heroImageBriefing:"", tiles:[] });

// â”€â”€ System prompts for each step â”€â”€
const SYSTEM_RESEARCH = `You are a brand research analyst. Given a brand name and marketplace, research the brand thoroughly using web search.

Search for:
1. The brand's website, mission, values, founding story
2. Their product categories and range
3. Their visual identity (colors, style, tone)
4. Their Amazon presence (if any)
5. Key competitors

Return ONLY valid JSON:
{
  "brandName": "...",
  "description": "2-3 sentence summary",
  "type": "premium|d2c|mission|mass_market",
  "tone": "e.g. premium-warm, energetic-fun, clinical-trust, functional-clean",
  "colors": { "primary": "#hex", "secondary": "#hex", "accent": "#hex" },
  "categories": ["Category 1", "Category 2", ...],
  "usps": ["USP 1", "USP 2", "USP 3"],
  "founderStory": "Brief founder/origin story or empty string",
  "targetAudience": "Who buys this",
  "priceRange": "e.g. â‚¬15-â‚¬45 mid-range",
  "competitorBrands": ["Competitor 1", "Competitor 2"]
}`;

const SYSTEM_AMAZON = `You are an Amazon marketplace analyst. Given a brand name and marketplace domain, find their actual Amazon products.

Search Amazon for this brand. Find:
1. Real product names and ASINs (format: B0XXXXXXXXX)
2. Product categories as they appear on Amazon
3. Price points
4. Whether they have an existing Brand Store
5. Their bestselling products

Return ONLY valid JSON:
{
  "hasExistingStore": true/false,
  "existingStorePages": ["page names if found"],
  "products": [
    { "name": "Product Name", "asin": "B0XXXXXXXXX", "price": "â‚¬XX.XX", "category": "Category", "isBestseller": true/false }
  ],
  "amazonCategories": ["Category as on Amazon"],
  "totalProducts": 42,
  "averageRating": 4.5
}`;

const SYSTEM_ARCHITECTURE = `You are an Amazon Brand Store architect. Based on the brand profile and Amazon product data provided, create the optimal page structure.

RULES:
- Homepage is always first
- One page per major product category
- Additional pages based on brand type:
  * Premium: "About/Mission" page, fewer but more editorial pages
  * D2C: "Bestseller", "Starter Sets/Bundles", "FÃ¼r Neukunden" pages
  * Mission: "Our Mission/Impact" page with stats
  * Mass Market: "Deals/Angebote", many category pages
- Min 4 pages, max 15 pages
- Each page gets a purpose description

Return ONLY valid JSON:
{
  "pages": [
    {
      "id": "homepage",
      "name": "Homepage",
      "purpose": "Brand introduction, category navigation, bestseller highlights",
      "tileSequence": [
        "hero_image describing the brand",
        "image tiles for category navigation (medium, 3-4 tiles)",
        "product_grid with bestsellers",
        "image_with_text for brand story",
        "shoppable_image with lifestyle shot",
        "best_sellers auto-tile"
      ]
    }
  ],
  "navigationOrder": ["Homepage", "Page2", ...]
}`;

const SYSTEM_CONTENT = `You are an Amazon Brand Store content creator and designer briefing specialist. You create content for ONE specific store page.

You will receive:
- Brand profile (type, colors, tone, USPs)
- Amazon product data (real ASINs, names, prices)
- Page specification (name, purpose, tile sequence)

CRITICAL RULES:
- Use ONLY these real Amazon tile types: hero_image, image, image_with_text, shoppable_image, text, video, background_video, gallery, product, product_grid, best_sellers, recommended, featured_deals
- Every image tile MUST have a detailed imageBriefing for the designer
- imageBriefing MUST include: exact pixel dimensions, what's in the image, text overlays with exact wording, colors with hex codes, mood/style, safe zone notes, mobile considerations
- All text content in the marketplace language
- Use real ASINs from the product data
- No placeholder text whatsoever
- Max 20 tiles per page
- Max 1 product_grid, 1 gallery, 1 featured_deals per page

Image briefing format:
"DIMENSIONS: 3000Ã—1000px, JPG, max 5MB | SAFE ZONE: mittlere 70% | CONTENT: [what's in the image] | TEXT IN IMAGE: '[exact headline]' (white, centered), '[subline]' (smaller, below) | COLORS: primary #hex, gradient from X to Y | MOOD: [style description] | MOBILE: text must stay in center 60%"

Return ONLY valid JSON:
{
  "pageName": "...",
  "heroImageBriefing": "detailed briefing for hero image of this page",
  "tiles": [
    {
      "type": "image_with_text",
      "size": "full_width",
      "content": { "layout": "text_over", "headline": "...", "body": "...", "linkText": "..." },
      "imageBriefing": "DIMENSIONS: ... | CONTENT: ... | TEXT IN IMAGE: ... | COLORS: ... | MOOD: ..."
    }
  ]
}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export default function App() {
  // Store state
  const [store, setStore] = useState({ brandName:"", brandProfile:null, amazonData:null, pages:[mkPage("Homepage","homepage")] });
  const [curPage, setCurPage] = useState("homepage");
  const [selTile, setSelTile] = useState(null);
  const [mode, setMode] = useState("builder");

  // AI state
  const [aiModal, setAiModal] = useState(false);
  const [aiBrand, setAiBrand] = useState("");
  const [aiMp, setAiMp] = useState("de");
  const [aiCat, setAiCat] = useState("");
  const [aiInfo, setAiInfo] = useState("");
  const [generating, setGenerating] = useState(false);
  const [genStep, setGenStep] = useState(0);
  const [genSteps, setGenSteps] = useState([]);
  const [genLog, setGenLog] = useState([]);
  const [refine, setRefine] = useState("");
  const [toast, setToast] = useState(null);

  const page = store.pages.find(p=>p.id===curPage) || store.pages[0];
  const tile = page?.tiles.find(t=>t.id===selTile);
  const tileDef = tile ? TILES[tile.type] : null;

  const showToast = (m,t="ok") => { setToast({m,t}); setTimeout(()=>setToast(null),4000); };
  const addLog = (msg) => setGenLog(prev=>[...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);

  // â”€â”€ Store mutations â”€â”€
  const up = (fn) => setStore(prev => { const n=JSON.parse(JSON.stringify(prev)); fn(n); return n; });
  const upPage = (fn) => up(s=>{ const p=s.pages.find(pg=>pg.id===curPage); if(p)fn(p); });
  const upTile = (fn) => upPage(p=>{ const t=p.tiles.find(ti=>ti.id===selTile); if(t)fn(t); });

  const addTile = (type) => { const t=mkTile(type); upPage(p=>p.tiles.push(t)); setSelTile(t.id); };
  const delTile = (id) => { upPage(p=>{p.tiles=p.tiles.filter(t=>t.id!==id);}); if(selTile===id)setSelTile(null); };
  const moveTile = (id,d) => upPage(p=>{ const i=p.tiles.findIndex(t=>t.id===id); const j=i+d; if(j>=0&&j<p.tiles.length)[p.tiles[i],p.tiles[j]]=[p.tiles[j],p.tiles[i]]; });
  const addPage = (name) => { const p=mkPage(name||"Neue Seite"); up(s=>s.pages.push(p)); setCurPage(p.id); setSelTile(null); };
  const delPage = (id) => { if(store.pages.length<=1)return; up(s=>{s.pages=s.pages.filter(p=>p.id!==id);}); if(curPage===id)setCurPage(store.pages.find(p=>p.id!==id)?.id); };

  // â”€â”€ Image upload â”€â”€
  const fileRef = useRef(null);
  const handleImg = (file) => {
    if(!file||!selTile)return;
    const r=new FileReader();
    r.onload=(e)=>{ const img=new Image(); img.onload=()=>{
      upTile(t=>{t.image=e.target.result;t.imageFile=file.name;t.imgW=img.width;t.imgH=img.height;t.imgSize=`${(file.size/1048576).toFixed(1)}MB`;});
      showToast(`Bild: ${img.width}Ã—${img.height}px`);
    }; img.src=e.target.result; };
    r.readAsDataURL(file);
  };

  // â”€â”€ AI Call Helper â”€â”€
  const callAI = async (system, user, useSearch=false) => {
    const body = {
      model: "claude-sonnet-4-20250514", max_tokens: 8000,
      system, messages: [{ role:"user", content:user }],
    };
    if(useSearch) body.tools = [{ type:"web_search_20250305", name:"web_search" }];
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(body),
    });
    const data = await resp.json();
    if(data.error) throw new Error(data.error.message || JSON.stringify(data.error));
    const text = (data.content||[]).filter(b=>b.type==="text").map(b=>b.text).join("");
    const match = text.match(/\{[\s\S]*\}/);
    if(!match) throw new Error("No JSON in response");
    return JSON.parse(match[0]);
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MULTI-STEP AI GENERATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const generate = async () => {
    if(!aiBrand.trim()) return showToast("Markenname fehlt!","err");
    setAiModal(false); setGenerating(true); setGenLog([]);
    const lang = {de:"German",com:"English","co.uk":"English",fr:"French",it:"Italian",es:"Spanish"}[aiMp]||"German";
    const curr = {de:"â‚¬ (EUR)",com:"$ (USD)","co.uk":"Â£ (GBP)",fr:"â‚¬ (EUR)"}[aiMp]||"â‚¬ (EUR)";
    const steps = [
      {name:"Marke recherchieren", desc:"Web Search: Website, Werte, Farben, Ton..."},
      {name:"Amazon-Daten sammeln", desc:"ASINs, Preise, Kategorien, bestehender Store..."},
      {name:"Store-Architektur erstellen", desc:"Seiten, Navigation, Tile-Sequenzen..."},
      {name:"Inhalte generieren", desc:"Texte, Bild-Briefings pro Seite..."},
      {name:"Validieren & aufbauen", desc:"PrÃ¼fen, Auto-Fix, Store zusammensetzen..."},
    ];
    setGenSteps(steps);

    try {
      // â”€â”€ STEP 1: Brand Research â”€â”€
      setGenStep(0); addLog("ğŸ” Starte Markenrecherche...");
      const brandProfile = await callAI(
        SYSTEM_RESEARCH,
        `Research the brand "${aiBrand}" for marketplace Amazon.${aiMp}.\n${aiCat?`Category hint: ${aiCat}`:""}${aiInfo?`\nAdditional info: ${aiInfo}`:""}\nRespond in English for the JSON structure, but brand-specific content in ${lang}.`,
        true
      );
      addLog(`âœ… Brand: ${brandProfile.type}, ${brandProfile.categories?.length||0} Kategorien, Ton: ${brandProfile.tone}`);

      // â”€â”€ STEP 2: Amazon Data â”€â”€
      setGenStep(1); addLog("ğŸ›’ Suche Amazon-Produkte...");
      const amazonData = await callAI(
        SYSTEM_AMAZON,
        `Find Amazon products for brand "${aiBrand}" on Amazon.${aiMp}. Search for "${aiBrand}" on amazon.${aiMp} and find real products with ASINs.\nKnown categories: ${(brandProfile.categories||[]).join(", ")}`,
        true
      );
      addLog(`âœ… ${amazonData.products?.length||0} Produkte gefunden, ${amazonData.amazonCategories?.length||0} Kategorien`);
      if(amazonData.hasExistingStore) addLog(`â„¹ï¸ Bestehender Store gefunden mit Seiten: ${(amazonData.existingStorePages||[]).join(", ")}`);

      // â”€â”€ STEP 3: Architecture â”€â”€
      setGenStep(2); addLog("ğŸ—ï¸ Erstelle Store-Architektur...");
      const architecture = await callAI(
        SYSTEM_ARCHITECTURE,
        `Create store architecture for:\n\nBRAND PROFILE:\n${JSON.stringify(brandProfile,null,2)}\n\nAMAZON DATA:\n- ${amazonData.products?.length||0} products\n- Categories: ${(amazonData.amazonCategories||[]).join(", ")}\n- Has existing store: ${amazonData.hasExistingStore}\n${amazonData.hasExistingStore?`- Existing pages: ${(amazonData.existingStorePages||[]).join(", ")}`:""}\n\nMarketplace: Amazon.${aiMp}, Language: ${lang}`,
        false
      );
      addLog(`âœ… Architektur: ${architecture.pages?.length||0} Seiten geplant`);
      architecture.pages?.forEach(p => addLog(`   ğŸ“„ ${p.name}: ${p.purpose?.slice(0,60)}...`));

      // â”€â”€ STEP 4: Content per page â”€â”€
      setGenStep(3);
      const builtPages = [];
      for(let i=0; i<(architecture.pages||[]).length; i++) {
        const pagePlan = architecture.pages[i];
        addLog(`ğŸ“ Generiere Seite ${i+1}/${architecture.pages.length}: "${pagePlan.name}"...`);

        const pageContent = await callAI(
          SYSTEM_CONTENT,
          `Create content for this store page:\n\nPAGE: ${JSON.stringify(pagePlan)}\n\nBRAND PROFILE:\n${JSON.stringify(brandProfile)}\n\nAMAZON PRODUCTS (use real ASINs!):\n${JSON.stringify(amazonData.products?.slice(0,20))}\n\nMarketplace: Amazon.${aiMp}\nLanguage: ${lang}\nCurrency: ${curr}\nBrand colors: ${JSON.stringify(brandProfile.colors)}`,
          false
        );

        const validTiles = (pageContent.tiles||[])
          .filter(t => TILES[t.type])
          .map(t => mkTile(t.type, t.size, t.content||{}, t.imageBriefing||""));

        builtPages.push({
          id: pagePlan.id || `page_${i}`,
          name: pageContent.pageName || pagePlan.name,
          heroImageBriefing: pageContent.heroImageBriefing || "",
          tiles: validTiles,
        });

        addLog(`   âœ… ${validTiles.length} Tiles, ${validTiles.filter(t=>t.imageBriefing).length} mit Bild-Briefing`);
      }

      // â”€â”€ STEP 5: Validation â”€â”€
      setGenStep(4); addLog("ğŸ” Validiere Store...");
      let warnings = 0;
      builtPages.forEach(p => {
        const pgCount = p.tiles.filter(t=>t.type==="product_grid").length;
        if(pgCount>1){ p.tiles = p.tiles.filter((t,i)=>t.type!=="product_grid"||p.tiles.findIndex(x=>x.type==="product_grid")===i); warnings++; }
        const galCount = p.tiles.filter(t=>t.type==="gallery").length;
        if(galCount>1){ p.tiles = p.tiles.filter((t,i)=>t.type!=="gallery"||p.tiles.findIndex(x=>x.type==="gallery")===i); warnings++; }
        if(p.tiles.length>20){ p.tiles=p.tiles.slice(0,20); warnings++; addLog(`âš ï¸ ${p.name}: auf 20 Tiles gekÃ¼rzt`); }
        p.tiles.forEach(t => {
          if(TILES[t.type]?.needsImage && !t.imageBriefing) { warnings++; addLog(`âš ï¸ ${p.name}: ${TILES[t.type]?.name} ohne Bild-Briefing`); }
        });
      });
      addLog(`âœ… Validierung abgeschlossen: ${warnings} Warnungen`);

      // â”€â”€ BUILD STORE â”€â”€
      setStore({
        brandName: aiBrand,
        brandProfile,
        amazonData,
        pages: builtPages,
      });
      setCurPage(builtPages[0]?.id);
      setSelTile(null);

      const totalTiles = builtPages.reduce((a,p)=>a+p.tiles.length,0);
      const totalBriefings = builtPages.reduce((a,p)=>a+p.tiles.filter(t=>t.imageBriefing).length,0);
      addLog(`\nğŸ‰ FERTIG: ${builtPages.length} Seiten, ${totalTiles} Tiles, ${totalBriefings} Bild-Briefings`);
      showToast(`Store generiert: ${builtPages.length} Seiten, ${totalTiles} Tiles`);

    } catch(e) {
      addLog(`âŒ FEHLER: ${e.message}`);
      showToast(`Fehler: ${e.message}`,"err");
    } finally {
      setGenerating(false);
    }
  };

  // â”€â”€ Refine â”€â”€
  const doRefine = async () => {
    if(!refine.trim()||!store.pages.length) return;
    setGenerating(true); setGenStep(0);
    setGenSteps([{name:"Verfeinere Store...",desc:refine}]);
    setGenLog([]); addLog(`âœï¸ Verfeinerung: "${refine}"`);
    const storeClean = JSON.parse(JSON.stringify(store));
    storeClean.pages.forEach(p=>p.tiles.forEach(t=>{t.image=null;}));
    try {
      const result = await callAI(
        `You refine an Amazon Brand Store. Use ONLY real Amazon tile types: ${Object.keys(TILES).join(", ")}. Include imageBriefing for every image tile. Return the COMPLETE store as JSON with the same structure.`,
        `CURRENT STORE:\n${JSON.stringify(storeClean,null,2)}\n\nCHANGE: ${refine}\n\nReturn complete updated JSON.`,
        false
      );
      if(result.pages?.length) {
        const pages = result.pages.map((p,i)=>({
          ...mkPage(p.name, p.id||`page_${i}`),
          heroImageBriefing: p.heroImageBriefing||"",
          tiles: (p.tiles||[]).filter(t=>TILES[t.type]).map(t=>mkTile(t.type,t.size,t.content||{},t.imageBriefing||""))
        }));
        up(s=>{ s.pages=pages; s.brandProfile=result.brandProfile||s.brandProfile; });
        setCurPage(pages[0]?.id);
        addLog("âœ… Store verfeinert");
        showToast("Store verfeinert!");
      }
    } catch(e) { addLog(`âŒ ${e.message}`); showToast(e.message,"err"); }
    finally { setGenerating(false); setRefine(""); }
  };

  // â”€â”€ Export Designer Briefing â”€â”€
  const exportBriefing = () => {
    const bp = store.brandProfile;
    let md = `# Designer Briefing: ${store.brandName}\n\n`;
    if(bp) {
      md += `## Brand Profile\n- **Typ:** ${bp.type}\n- **Ton:** ${bp.tone}\n- **Farben:** Primary ${bp.colors?.primary}, Secondary ${bp.colors?.secondary}, Accent ${bp.colors?.accent}\n- **USPs:** ${(bp.usps||[]).join(" | ")}\n- **Zielgruppe:** ${bp.targetAudience}\n\n`;
    }
    md += `## Brand Logo\n- **Spec:** 400Ã—400px, max 5MB, JPG/PNG\n\n---\n\n`;
    store.pages.forEach((pg,pi) => {
      md += `# Seite ${pi+1}: ${pg.name}\n\n`;
      md += `## Hero Image\n- **Spec:** 3000Ã—600px min, max 5MB, Safe Zone mittlere 70%\n- **Briefing:** ${pg.heroImageBriefing||"â€”"}\n\n`;
      pg.tiles.forEach((t,ti) => {
        const def = TILES[t.type];
        md += `### ${ti+1}. ${def?.name||t.type} (${SIZE_LABELS[t.size]||t.size})\n`;
        const spec = def?.specs?.[t.size] || (def?.specs ? Object.values(def.specs)[0] : null);
        if(spec) { Object.entries(spec).forEach(([k,v])=>{ md += `- **${k}:** ${v}\n`; }); }
        if(t.imageBriefing) md += `- **ğŸ¨ BRIEFING:** ${t.imageBriefing}\n`;
        if(t.image) md += `- **âœ… Bild:** ${t.imageFile} (${t.imgW}Ã—${t.imgH}px, ${t.imgSize})\n`;
        else if(def?.needsImage) md += `- **âš ï¸ Bild fehlt**\n`;
        const c = t.content||{};
        if(c.headline) md += `- **Headline:** ${c.headline}\n`;
        if(c.body) md += `- **Body:** ${c.body}\n`;
        if(c.text) md += `- **Text:** ${c.text}\n`;
        if(c.asin) md += `- **ASIN:** ${c.asin}\n`;
        md += `\n`;
      });
      md += `---\n\n`;
    });
    const blob = new Blob([md],{type:"text/markdown"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${store.brandName||"store"}_designer_briefing.md`;
    a.click();
    showToast("Designer-Briefing exportiert!");
  };

  const exportJSON = () => {
    const d = JSON.parse(JSON.stringify(store));
    d.pages.forEach(p=>p.tiles.forEach(t=>{t.image=null;}));
    const blob = new Blob([JSON.stringify(d,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${store.brandName||"store"}.json`;
    a.click();
    showToast("JSON exportiert!");
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const accent = store.brandProfile?.colors?.primary || "#FF9900";
  const dark = "#1a1a2e";

  return (
    <div className="flex flex-col h-screen overflow-hidden" style={{fontFamily:"'Segoe UI',system-ui,sans-serif",background:"#f0f1f3"}}>
      {/* â”€â”€ HEADER â”€â”€ */}
      <header className="flex items-center h-13 px-4 gap-3 flex-shrink-0" style={{background:dark,height:52}}>
        <div className="flex items-center gap-2 text-white font-bold text-sm">
          <span className="text-base">ğŸª</span>
          <span>Store Builder</span>
          <span className="text-xs px-1.5 py-0.5 rounded font-extrabold" style={{background:"#FF9900",color:dark,fontSize:9}}>MULTI-STEP AI</span>
        </div>
        {store.brandProfile && (
          <div className="flex items-center gap-2 ml-3 px-2 py-1 rounded" style={{background:"rgba(255,255,255,.08)"}}>
            <span className="w-3 h-3 rounded-full" style={{background:accent}} />
            <span className="text-xs text-gray-300">{store.brandName} Â· {store.brandProfile.type}</span>
          </div>
        )}
        <div className="flex-1 flex justify-center gap-1">
          {[["builder","âœï¸ Builder"],["preview","ğŸ‘ï¸ Preview"],["briefing","ğŸ“‹ Briefing"]].map(([m,l])=>(
            <button key={m} onClick={()=>setMode(m)}
              className={`px-3 py-1 rounded text-xs font-semibold ${mode===m?"text-white":"text-gray-500 hover:text-gray-300"}`}
              style={mode===m?{background:"rgba(255,255,255,.12)"}:{}}>
              {l}
            </button>
          ))}
        </div>
        <div className="flex gap-1.5">
          <button onClick={()=>setAiModal(true)} className="px-3 py-1.5 rounded text-xs font-bold" style={{background:"#FF9900",color:dark}}>âœ¨ AI Generieren</button>
          <button onClick={exportBriefing} className="px-2.5 py-1.5 rounded text-xs font-semibold border border-gray-600 text-gray-400 hover:text-white">ğŸ“‹ Briefing</button>
          <button onClick={exportJSON} className="px-2.5 py-1.5 rounded text-xs font-semibold border border-gray-600 text-gray-400 hover:text-white">ğŸ“¥ JSON</button>
        </div>
      </header>

      {/* â”€â”€ MAIN â”€â”€ */}
      <div className="flex flex-1 overflow-hidden">

        {/* â”€â”€ SIDEBAR â”€â”€ */}
        {mode==="builder" && (
          <aside className="w-56 bg-white border-r flex flex-col flex-shrink-0 overflow-hidden" style={{borderColor:"#e2e4e8"}}>
            <div className="p-2.5 border-b text-xs font-bold text-gray-400 uppercase tracking-wider" style={{borderColor:"#e2e4e8",fontSize:10}}>Amazon Tiles</div>
            <div className="flex-1 overflow-y-auto p-1.5">
              {GROUPS.map(g=>(
                <div key={g} className="mb-2">
                  <div className="text-xs font-bold text-gray-400 uppercase px-2 mb-0.5" style={{fontSize:9,letterSpacing:".5px"}}>{g}</div>
                  {Object.entries(TILES).filter(([,v])=>v.grp===g).map(([k,v])=>(
                    <button key={k} onClick={()=>addTile(k)}
                      className="w-full flex items-center gap-1.5 px-2 py-1.5 rounded text-left hover:bg-gray-50 mb-px transition-all"
                      style={{fontSize:12}}>
                      <span className="text-sm flex-shrink-0">{v.icon}</span>
                      <span className="font-medium text-gray-700 truncate">{v.name}</span>
                    </button>
                  ))}
                </div>
              ))}
            </div>
          </aside>
        )}

        {/* â”€â”€ CANVAS â”€â”€ */}
        <div className="flex-1 flex flex-col overflow-hidden">
          {/* Page tabs */}
          <div className="flex items-center gap-1 px-3 py-1.5 bg-white border-b overflow-x-auto flex-shrink-0" style={{borderColor:"#e2e4e8"}}>
            {store.pages.map(p=>(
              <button key={p.id} onClick={()=>{setCurPage(p.id);setSelTile(null);}}
                className={`px-2.5 py-1 rounded text-xs font-semibold border whitespace-nowrap flex items-center gap-1 ${p.id===curPage?"text-white":"text-gray-500 border-gray-200 hover:border-gray-400"}`}
                style={p.id===curPage?{background:dark,borderColor:dark}:{}}>
                {p.name}
                {store.pages.length>1 && <span onClick={e=>{e.stopPropagation();delPage(p.id);}} className="opacity-40 hover:opacity-100 ml-1" style={{fontSize:10}}>âœ•</span>}
              </button>
            ))}
            <button onClick={()=>{const n=prompt("Seitenname:");if(n)addPage(n);}} className="px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-400 hover:text-gray-600">+ Seite</button>
          </div>

          {/* Canvas scroll area */}
          <div className="flex-1 overflow-y-auto p-4">
            <div className="max-w-4xl mx-auto">
              {page && (
                <>
                  {/* Hero area */}
                  {mode!=="preview" && (
                    <div className="mb-3 rounded-lg border-2 border-dashed border-gray-300 overflow-hidden" style={{minHeight:100,background:`linear-gradient(135deg,${dark},#2d2d5e)`}}>
                      <div className="flex flex-col items-center justify-center p-6 text-white/50 text-center">
                        <span className="text-xl mb-1">ğŸ–¼ï¸</span>
                        <div className="text-xs font-semibold">Hero Image Â· 3000Ã—600px Â· Safe Zone 70%</div>
                        {page.heroImageBriefing && <div className="text-xs mt-1 text-white/30 italic max-w-lg truncate">"{page.heroImageBriefing.slice(0,80)}..."</div>}
                      </div>
                    </div>
                  )}

                  {/* Tiles */}
                  {page.tiles.length===0 && mode!=="preview" && (
                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center text-gray-400 bg-white">
                      <div className="text-2xl mb-2">ğŸ“¦</div>
                      <div className="font-semibold text-gray-500 text-sm">Keine Tiles</div>
                      <div className="text-xs mt-1">Klicke links auf ein Tile oder starte mit âœ¨ AI Generieren</div>
                    </div>
                  )}

                  {page.tiles.map(t => {
                    const def = TILES[t.type];
                    const isSel = selTile===t.id;
                    const c = t.content||{};
                    const hasImg = !!t.image;

                    // Tile inner content
                    let inner;
                    if(t.type==="text") {
                      inner = <div className="p-5"><p className="text-sm text-gray-600 leading-relaxed" style={{textAlign:c.alignment||"left"}}>{c.text||"Text..."}</p></div>;
                    } else if(t.type==="image_with_text") {
                      inner = (
                        <div className={`flex ${c.layout==="text_beside"?"flex-row":"flex-col"}`} style={{minHeight:180}}>
                          <div className="flex-1 bg-gray-100 flex items-center justify-center text-gray-300 text-3xl" style={{minHeight:140}}>
                            {hasImg ? <img src={t.image} alt="" className="w-full h-auto" /> : "ğŸ–¼ï¸"}
                          </div>
                          <div className="flex-1 p-5 flex flex-col justify-center">
                            {c.headline && <h3 className="font-bold text-base mb-2">{c.headline}</h3>}
                            {c.body && <p className="text-sm text-gray-500 leading-relaxed">{c.body}</p>}
                            {c.linkText && <span className="text-sm font-semibold mt-2" style={{color:"#007EB9"}}>{c.linkText} â†’</span>}
                          </div>
                        </div>
                      );
                    } else if(t.type==="product_grid") {
                      inner = <div className="p-5"><div className="text-sm font-semibold mb-2">Product Grid ({c.layout||"standard"})</div><div className="grid grid-cols-4 gap-2">{[1,2,3,4,5,6,7,8].map(i=><div key={i} className="bg-gray-50 border rounded p-2 text-center"><div className="w-full aspect-square bg-gray-100 rounded mb-1 flex items-center justify-center text-gray-300">ğŸ“¦</div><div className="text-xs text-gray-400 truncate">{c.asins?.[i-1]||`Produkt ${i}`}</div></div>)}</div></div>;
                    } else if(t.type==="product") {
                      inner = <div className="p-4 flex items-center gap-3"><div className="w-16 h-16 bg-gray-100 rounded flex items-center justify-center text-xl text-gray-300">ğŸ“¦</div><div><div className="font-semibold text-sm">{c.customTitle||c.name||"Produkt"}</div><div className="text-xs text-gray-400 font-mono mt-0.5">{c.asin||"ASIN"}</div>{c.price&&<div className="text-sm font-bold mt-0.5" style={{color:"#CC0C39"}}>{c.price}</div>}</div></div>;
                    } else if(t.type==="best_sellers") {
                      inner = <div className="p-5 text-center bg-gradient-to-r from-amber-50 to-orange-50"><span className="text-lg">ğŸ†</span><div className="text-sm font-semibold mt-1">Best Sellers</div><div className="text-xs text-gray-400">Auto â€” Top 5 Produkte</div></div>;
                    } else if(t.type==="recommended") {
                      inner = <div className="p-5 text-center bg-blue-50"><span className="text-lg">ğŸ’¡</span><div className="text-sm font-semibold mt-1">Recommended Products</div><div className="text-xs text-gray-400">Personalisiert</div></div>;
                    } else if(t.type==="featured_deals") {
                      inner = <div className="p-5 text-center bg-orange-50"><span className="text-lg">ğŸ·ï¸</span><div className="text-sm font-semibold mt-1">Featured Deals</div><div className="text-xs text-gray-400">Aktive Promotions</div></div>;
                    } else if(t.type==="gallery") {
                      inner = <div className="p-4"><div className="grid grid-cols-4 gap-2">{[1,2,3,4].map(i=><div key={i} className="aspect-square bg-gray-100 rounded flex items-center justify-center text-gray-300 text-xl">ğŸ–¼ï¸</div>)}</div></div>;
                    } else if(t.type==="video"||t.type==="background_video") {
                      inner = <div className="flex items-center justify-center p-8 text-4xl" style={{background:dark,minHeight:160,color:"rgba(255,255,255,.3)"}}>â–¶<div className="absolute text-xs" style={{bottom:8}}>{ t.type==="background_video"?"BG Video (stumm)":"Video"}</div></div>;
                    } else if(t.type==="shoppable_image") {
                      inner = hasImg
                        ? <div className="relative"><img src={t.image} alt="" className="w-full h-auto" /><div className="absolute top-2 right-2 px-2 py-0.5 bg-white/90 rounded text-xs font-semibold shadow">ğŸ›’ Shoppable</div></div>
                        : <div className="flex flex-col items-center justify-center p-8 bg-gray-100 text-gray-400" style={{minHeight:180}}><span className="text-3xl mb-2">ğŸ›’ğŸ–¼ï¸</span><div className="text-xs">Shoppable Image Â· bis 6 Hotspots</div></div>;
                    } else {
                      // image, hero_image
                      inner = hasImg
                        ? <img src={t.image} alt="" className="w-full h-auto block" />
                        : <div className="flex flex-col items-center justify-center p-8 bg-gray-100 text-gray-400" style={{minHeight:140}}>
                            <span className="text-3xl mb-2">ğŸ–¼ï¸</span>
                            <div className="text-xs font-semibold">{def?.name}</div>
                            {t.imageBriefing && <div className="text-xs mt-1 text-gray-400 italic max-w-md text-center truncate">"{t.imageBriefing.slice(0,80)}..."</div>}
                          </div>;
                    }

                    if(mode==="preview") return <div key={t.id} className="mb-0">{inner}</div>;

                    return (
                      <div key={t.id} onClick={()=>setSelTile(t.id)}
                        className={`bg-white rounded-lg overflow-hidden shadow-sm mb-2.5 cursor-pointer transition-all relative group border-2 ${isSel?"shadow-md":"hover:shadow-md hover:border-gray-200"}`}
                        style={{borderColor:isSel?accent:"transparent"}}>
                        <div className="absolute top-1.5 left-1.5 z-10 px-1.5 py-0.5 rounded text-white font-bold" style={{background:dark,fontSize:9}}>{def?.name} Â· {SIZE_LABELS[t.size]}</div>
                        <div className="absolute top-1.5 right-1.5 z-10 flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button onClick={e=>{e.stopPropagation();moveTile(t.id,-1);}} className="w-5 h-5 bg-white/90 shadow rounded flex items-center justify-center hover:bg-gray-800 hover:text-white" style={{fontSize:10}}>â†‘</button>
                          <button onClick={e=>{e.stopPropagation();moveTile(t.id,1);}} className="w-5 h-5 bg-white/90 shadow rounded flex items-center justify-center hover:bg-gray-800 hover:text-white" style={{fontSize:10}}>â†“</button>
                          <button onClick={e=>{e.stopPropagation();delTile(t.id);}} className="w-5 h-5 bg-white/90 shadow rounded flex items-center justify-center hover:bg-red-600 hover:text-white" style={{fontSize:10}}>âœ•</button>
                        </div>
                        {t.imageBriefing && !hasImg && <div className="absolute bottom-1.5 right-1.5 z-10 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded font-semibold" style={{fontSize:9}}>ğŸ“‹ Briefing</div>}
                        {hasImg && <div className="absolute bottom-1.5 left-1.5 z-10 px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-semibold" style={{fontSize:9}}>âœ“ {t.imgW}Ã—{t.imgH}</div>}
                        {inner}
                      </div>
                    );
                  })}
                </>
              )}
            </div>
          </div>

          {/* Refine bar */}
          {mode==="builder" && (
            <div className="flex gap-2 p-2.5 bg-white border-t flex-shrink-0" style={{borderColor:"#e2e4e8"}}>
              <input value={refine} onChange={e=>setRefine(e.target.value)} onKeyDown={e=>e.key==="Enter"&&doRefine()}
                className="flex-1 px-3 py-1.5 border rounded-lg text-sm" placeholder="AI-Anweisung: 'FÃ¼ge Bundle-Seite hinzu', 'Mehr Lifestyle-Bilder'..." style={{borderColor:"#ddd"}} />
              <button onClick={doRefine} className="px-4 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap" style={{background:"#FF9900",color:dark}}>âœ¨ Verfeinern</button>
            </div>
          )}
        </div>

        {/* â”€â”€ PROPERTIES PANEL â”€â”€ */}
        {mode==="builder" && (
          <aside className="w-72 bg-white border-l flex flex-col flex-shrink-0 overflow-hidden" style={{borderColor:"#e2e4e8"}}>
            <div className="p-2.5 border-b text-xs font-bold text-gray-400 uppercase tracking-wider flex justify-between" style={{borderColor:"#e2e4e8",fontSize:10}}>
              Eigenschaften {tile && <span style={{color:accent,textTransform:"none",fontWeight:500}}>{tile.type}</span>}
            </div>
            <div className="flex-1 overflow-y-auto p-2.5">
              {!tile ? (
                <div className="text-center text-gray-400 pt-8"><div className="text-xl mb-2 opacity-30">ğŸ¯</div><div className="text-xs">Tile auswÃ¤hlen</div></div>
              ) : (
                <div className="space-y-3">
                  {/* Size */}
                  <div>
                    <label className="text-xs font-semibold text-gray-500 uppercase block mb-1" style={{fontSize:10}}>Tile-GrÃ¶ÃŸe</label>
                    <select value={tile.size} onChange={e=>upTile(t=>{t.size=e.target.value;})} className="w-full px-2 py-1 border rounded text-xs" style={{borderColor:"#ddd"}}>
                      {tileDef?.sizes.map(s=><option key={s} value={s}>{SIZE_LABELS[s]}</option>)}
                    </select>
                  </div>

                  {/* Image Specs */}
                  {tileDef?.needsImage && tileDef.specs && (
                    <div className="bg-amber-50 border border-amber-200 rounded p-2.5">
                      <div className="text-xs font-bold text-amber-700 mb-1.5" style={{fontSize:10}}>ğŸ“ Bild-Spezifikationen</div>
                      {Object.entries(tileDef.specs[tile.size]||tileDef.specs[Object.keys(tileDef.specs)[0]]||{}).map(([k,v])=>(
                        <div key={k} className="text-xs text-amber-800"><b>{k}:</b> {v}</div>
                      ))}
                    </div>
                  )}

                  {/* Image Upload */}
                  {tileDef?.needsImage && (
                    <div>
                      <label className="text-xs font-semibold text-gray-500 uppercase block mb-1" style={{fontSize:10}}>Bild hochladen</label>
                      <input ref={fileRef} type="file" accept="image/*" className="hidden" onChange={e=>handleImg(e.target.files?.[0])} />
                      <button onClick={()=>fileRef.current?.click()}
                        className="w-full py-2 border-2 border-dashed rounded-lg text-xs text-gray-500 hover:border-amber-400 hover:text-amber-600 transition-all"
                        style={{borderColor:tile.image?"#86efac":"#ddd"}}>
                        {tile.image ? `âœ“ ${tile.imageFile} (${tile.imgW}Ã—${tile.imgH})` : "ğŸ“ Bild wÃ¤hlen..."}
                      </button>
                    </div>
                  )}

                  {/* Designer Briefing */}
                  {tileDef?.needsImage && (
                    <div>
                      <label className="text-xs font-semibold text-gray-500 uppercase block mb-1" style={{fontSize:10}}>ğŸ¨ Designer-Briefing</label>
                      <textarea value={tile.imageBriefing||""} onChange={e=>upTile(t=>{t.imageBriefing=e.target.value;})}
                        className="w-full px-2 py-1.5 border rounded text-xs resize-y" style={{borderColor:"#ddd",minHeight:80}}
                        placeholder="DIMENSIONS: ... | CONTENT: ... | TEXT IN IMAGE: ... | COLORS: ... | MOOD: ..." />
                    </div>
                  )}

                  {/* Content fields */}
                  {tile.type==="image_with_text" && <>
                    <Sel label="Layout" value={tile.content.layout} opts={[["text_over","Text Ã¼ber Bild"],["text_beside","Text neben Bild"]]} onChange={v=>upTile(t=>{t.content.layout=v;})} />
                    <Inp label="Headline" value={tile.content.headline} onChange={v=>upTile(t=>{t.content.headline=v;})} />
                    <Txt label="Body" value={tile.content.body} onChange={v=>upTile(t=>{t.content.body=v;})} />
                    <Inp label="Link-Text" value={tile.content.linkText} onChange={v=>upTile(t=>{t.content.linkText=v;})} />
                  </>}
                  {tile.type==="text" && <>
                    <Txt label="Text" value={tile.content.text} onChange={v=>upTile(t=>{t.content.text=v;})} />
                    <Sel label="Ausrichtung" value={tile.content.alignment} opts={[["left","Links"],["center","Zentriert"],["right","Rechts"],["justified","Block"]]} onChange={v=>upTile(t=>{t.content.alignment=v;})} />
                  </>}
                  {tile.type==="product" && <>
                    <Inp label="ASIN" value={tile.content.asin} onChange={v=>upTile(t=>{t.content.asin=v;})} ph="B0XXXXXXXXX" />
                    <Inp label="Titel" value={tile.content.customTitle||tile.content.name} onChange={v=>upTile(t=>{t.content.customTitle=v;})} />
                    <Inp label="Preis" value={tile.content.price} onChange={v=>upTile(t=>{t.content.price=v;})} />
                  </>}
                  {tile.type==="product_grid" && <>
                    <Sel label="Layout" value={tile.content.layout} opts={[["standard","Standard"],["tall","Tall (Fashion)"]]} onChange={v=>upTile(t=>{t.content.layout=v;})} />
                    <Txt label="ASINs (eine/Zeile)" value={(tile.content.asins||[]).join("\n")} onChange={v=>upTile(t=>{t.content.asins=v.split("\n").filter(Boolean);})} ph="B0XXXXXXXXX" />
                  </>}
                  {(tile.type==="image"||tile.type==="hero_image") && <>
                    <Inp label="Alt-Text" value={tile.content.altText} onChange={v=>upTile(t=>{t.content.altText=v;})} />
                  </>}
                  {(tile.type==="video"||tile.type==="background_video") && <>
                    <Txt label="Video-Beschreibung" value={tile.content.videoDescription} onChange={v=>upTile(t=>{t.content.videoDescription=v;})} ph="Was zeigt das Video?" />
                  </>}
                </div>
              )}
            </div>
          </aside>
        )}

        {/* â”€â”€ BRIEFING PANEL â”€â”€ */}
        {mode==="briefing" && (
          <aside className="w-80 bg-white border-l flex flex-col flex-shrink-0 overflow-hidden" style={{borderColor:"#e2e4e8"}}>
            <div className="p-2.5 border-b text-xs font-bold text-gray-400 uppercase tracking-wider" style={{borderColor:"#e2e4e8",fontSize:10}}>ğŸ“ Bild-Specs & Briefings</div>
            <div className="flex-1 overflow-y-auto p-2.5">
              {/* Brand info */}
              {store.brandProfile && (
                <div className="bg-gray-50 border rounded p-2.5 mb-3" style={{borderColor:"#e2e4e8"}}>
                  <div className="text-xs font-bold mb-1">{store.brandName}</div>
                  <div className="flex gap-1 mb-1">{Object.values(store.brandProfile.colors||{}).map((c,i)=><span key={i} className="w-4 h-4 rounded-full border" style={{background:c,borderColor:"#ddd"}} />)}</div>
                  <div className="text-xs text-gray-500">{store.brandProfile.type} Â· {store.brandProfile.tone}</div>
                </div>
              )}
              {/* Hero */}
              <div className="bg-blue-50 border border-blue-200 rounded p-2.5 mb-2">
                <div className="text-xs font-bold text-blue-800">Hero Image</div>
                <div className="text-xs text-blue-700 mt-0.5">3000Ã—600px | max 5MB | Safe Zone 70%</div>
                {page?.heroImageBriefing && <div className="text-xs text-blue-600 mt-1 italic">{page.heroImageBriefing}</div>}
              </div>
              {/* Tiles */}
              {page?.tiles.map((t,i) => {
                const def = TILES[t.type];
                const needsImg = def?.needsImage;
                return (
                  <div key={t.id} className={`rounded p-2.5 mb-1.5 border ${needsImg?"bg-amber-50 border-amber-200":"bg-gray-50 border-gray-200"}`}>
                    <div className="text-xs font-bold" style={{color:needsImg?"#92400e":"#6b7280"}}>{i+1}. {def?.name} ({SIZE_LABELS[t.size]})</div>
                    {needsImg && def.specs && Object.entries(def.specs[t.size]||Object.values(def.specs)[0]||{}).map(([k,v])=>(
                      <div key={k} className="text-xs text-amber-700"><b>{k}:</b> {v}</div>
                    ))}
                    {t.imageBriefing && <div className="text-xs mt-1 p-1.5 bg-white rounded border border-amber-100">ğŸ¨ {t.imageBriefing}</div>}
                    {t.image ? <div className="text-xs text-green-700 font-semibold mt-1">âœ“ {t.imageFile} ({t.imgW}Ã—{t.imgH})</div>
                             : needsImg && <div className="text-xs text-red-600 font-semibold mt-1">âš  Bild fehlt</div>}
                  </div>
                );
              })}
            </div>
          </aside>
        )}
      </div>

      {/* â”€â”€ AI MODAL â”€â”€ */}
      {aiModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm" onClick={()=>setAiModal(false)}>
          <div className="bg-white rounded-2xl max-w-md w-11/12 shadow-2xl" onClick={e=>e.stopPropagation()}>
            <div className="p-5 pb-2">
              <h2 className="text-lg font-extrabold">âœ¨ Multi-Step AI Generator</h2>
              <p className="text-xs text-gray-400 mt-0.5">5 fokussierte AI-Calls statt 1 generischer</p>
            </div>
            <div className="p-5 pt-2 space-y-2.5">
              <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>Markenname *</label>
                <input value={aiBrand} onChange={e=>setAiBrand(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="z.B. natural elements, HOLY Energy, KÃ¤rcher..." style={{borderColor:"#ddd"}} /></div>
              <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>Marktplatz</label>
                <select value={aiMp} onChange={e=>setAiMp(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" style={{borderColor:"#ddd"}}>
                  <option value="de">ğŸ‡©ğŸ‡ª Amazon.de</option><option value="com">ğŸ‡ºğŸ‡¸ Amazon.com</option><option value="co.uk">ğŸ‡¬ğŸ‡§ Amazon.co.uk</option>
                  <option value="fr">ğŸ‡«ğŸ‡· Amazon.fr</option><option value="it">ğŸ‡®ğŸ‡¹ Amazon.it</option><option value="es">ğŸ‡ªğŸ‡¸ Amazon.es</option>
                </select></div>
              <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>Kategorie (optional)</label>
                <input value={aiCat} onChange={e=>setAiCat(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" style={{borderColor:"#ddd"}} /></div>
              <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>ZusÃ¤tzliche Infos (optional)</label>
                <textarea value={aiInfo} onChange={e=>setAiInfo(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" rows={2} style={{borderColor:"#ddd"}} /></div>
            </div>
            <div className="p-5 pt-1 flex justify-end gap-2">
              <button onClick={()=>setAiModal(false)} className="px-4 py-2 rounded-lg text-xs font-semibold bg-gray-100 border text-gray-600" style={{borderColor:"#ddd"}}>Abbrechen</button>
              <button onClick={generate} className="px-5 py-2 rounded-lg text-xs font-bold" style={{background:"#FF9900",color:dark}}>ğŸš€ Generieren (5 Steps)</button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ GENERATION OVERLAY â”€â”€ */}
      {generating && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
          <div className="bg-white rounded-2xl max-w-lg w-11/12 shadow-2xl overflow-hidden">
            <div className="p-5 pb-3">
              <div className="text-base font-bold mb-3">Store wird generiert...</div>
              {/* Steps */}
              <div className="space-y-1.5 mb-4">
                {genSteps.map((s,i) => (
                  <div key={i} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs ${i<genStep?"bg-green-50 text-green-700":i===genStep?"bg-amber-50 text-amber-800 font-semibold":"bg-gray-50 text-gray-400"}`}>
                    <span className="text-sm w-5 text-center">{i<genStep?"âœ…":i===genStep?"â³":"â¬œ"}</span>
                    <div><div className="font-semibold">{s.name}</div><div className="font-normal opacity-70">{s.desc}</div></div>
                  </div>
                ))}
              </div>
            </div>
            {/* Live log */}
            <div className="bg-gray-900 p-4 max-h-48 overflow-y-auto" style={{fontFamily:"'Menlo','Consolas',monospace"}}>
              {genLog.map((l,i) => <div key={i} className="text-xs text-green-400 leading-relaxed">{l}</div>)}
              {genLog.length>0 && <div className="text-xs text-green-400 animate-pulse mt-1">_</div>}
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ TOAST â”€â”€ */}
      {toast && (
        <div className="fixed top-4 right-4 z-50">
          <div className={`px-4 py-2.5 rounded-xl text-xs font-semibold shadow-xl text-white ${toast.t==="err"?"bg-red-600":"bg-emerald-700"}`}>
            {toast.t==="ok"?"âœ“":"âœ•"} {toast.m}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ Form components â”€â”€
function Inp({label,value,onChange,ph}) {
  return <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>{label}</label>
    <input value={value||""} onChange={e=>onChange(e.target.value)} className="w-full px-2 py-1 border rounded text-xs" style={{borderColor:"#ddd"}} placeholder={ph} /></div>;
}
function Txt({label,value,onChange,ph}) {
  return <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>{label}</label>
    <textarea value={value||""} onChange={e=>onChange(e.target.value)} className="w-full px-2 py-1 border rounded text-xs resize-y" style={{borderColor:"#ddd",minHeight:56}} placeholder={ph} /></div>;
}
function Sel({label,value,opts,onChange}) {
  return <div><label className="text-xs font-semibold text-gray-500 uppercase block mb-0.5" style={{fontSize:10}}>{label}</label>
    <select value={value||opts[0]?.[0]} onChange={e=>onChange(e.target.value)} className="w-full px-2 py-1 border rounded text-xs" style={{borderColor:"#ddd"}}>
      {opts.map(([v,l])=><option key={v} value={v}>{l}</option>)}
    </select></div>;
}
