<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amazon Brand Store Builder</title>
<style>
:root{--amz:#FF9900;--dark:#232F3E;--blue:#007EB9;--green:#059669;--red:#dc2626;--gray:#6b7280;--border:#d5d9d9;--bg:#f0f2f2;--text:#0F1111;--text2:#565959}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Amazon Ember','Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:14px}
#app{display:flex;flex-direction:column;height:100vh}
button{cursor:pointer;border:none;background:none;font-family:inherit;font-size:inherit}
input,textarea,select{font-family:inherit;outline:none;font-size:13px}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}
.topbar{display:flex;align-items:center;height:44px;padding:0 16px;gap:8px;background:var(--dark);flex-shrink:0;color:#fff;font-size:13px}
.topbar .logo{font-weight:700;font-size:14px}.topbar .logo b{color:var(--amz)}
.topbar .spacer{flex:1}
.tb{padding:5px 12px;border-radius:3px;font-size:12px;font-weight:600;border:1px solid #888;color:#fff}
.tb:hover{background:rgba(255,255,255,.1)}
.tb.p{background:var(--amz);color:var(--dark);border-color:var(--amz)}
.toolbar{display:flex;align-items:center;height:36px;padding:0 16px;gap:8px;background:#fff;border-bottom:1px solid var(--border);flex-shrink:0}
.dtog{display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.dtog button{padding:3px 10px;font-size:11px;font-weight:600;background:#fff;border-right:1px solid var(--border)}
.dtog button:last-child{border:none}
.dtog button.a{background:var(--dark);color:#fff}
.toolbar .spacer{flex:1}
.main{display:flex;flex:1;overflow:hidden;min-height:0}
/* Left */
.sl{width:200px;background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sl h2{font-size:16px;font-weight:800;padding:10px 12px;border-bottom:1px solid var(--border)}
.sl .abtn{display:flex;align-items:center;gap:4px;padding:6px 10px;margin:6px 8px;border:1px solid var(--border);border-radius:3px;font-size:12px;font-weight:600}
.sl .abtn:hover{background:#f7f7f7}
.plist{flex:1;overflow-y:auto;padding:4px 6px}
.pi{display:flex;align-items:center;gap:4px;padding:6px;border-left:3px solid transparent;border-radius:0 3px 3px 0;font-size:12px;cursor:pointer;margin-bottom:1px}
.pi:hover{background:#f5f5f5}
.pi.a{border-left-color:var(--blue);background:#e8f4f8;font-weight:700}
.pi .n{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pi .m{color:#999;font-size:14px}
/* Canvas */
.cw{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.canvas{flex:1;overflow-y:auto;background:var(--bg);padding:12px}
.ci{margin:0 auto;transition:max-width .3s}
/* Store Header */
.sh{background:#fff;border:2px solid transparent;border-radius:3px;margin-bottom:8px;cursor:pointer}
.sh:hover,.sh.s{border-color:var(--blue)}
.sh-top{display:flex;align-items:center;padding:10px 16px;gap:10px}
.sh-logo{width:40px;height:40px;background:#eee;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:16px}
.sh-nav{display:flex;gap:16px;padding:0 16px 8px;font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase}
.sh-nav span{cursor:pointer;padding-bottom:3px}.sh-nav span.a{color:var(--blue);border-bottom:2px solid var(--blue)}
/* Section */
.sec{background:#fff;border:2px solid transparent;border-radius:3px;margin-bottom:8px;cursor:pointer;position:relative}
.sec:hover,.sec.s{border-color:var(--blue)}
.sec-lbl{position:absolute;top:-8px;left:10px;background:var(--blue);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:2px;z-index:5;display:none}
.sec:hover .sec-lbl,.sec.s .sec-lbl{display:block}
.lg{display:grid;gap:0;min-height:80px}
.lc{border:1px dashed #d5d9d9;display:flex;align-items:center;justify-content:center;min-height:80px;background:#fafafa;position:relative;overflow:hidden}
.lc:hover{background:#fff8ee}
.lc.f{background:#fff;border-style:solid;border-color:#eee}
.lc .ph{display:flex;flex-direction:column;align-items:center;gap:3px;color:#bbb;font-size:12px}
/* Tile badge */
.tbdg{position:absolute;top:3px;left:3px;background:rgba(0,0,0,.55);color:#fff;font-size:8px;font-weight:700;padding:1px 5px;border-radius:2px;z-index:5}
.timgph{flex:1;display:flex;align-items:center;justify-content:center;background:#f3f4f6;color:#d1d5db;font-size:24px;min-height:60px;width:100%}
.ttxt{padding:8px;font-size:12px;color:var(--text2);line-height:1.4}
.tauto{padding:14px;text-align:center;background:linear-gradient(135deg,#f0f7ff,#fff7ed);font-weight:600;font-size:12px}
.tprod{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;font-size:12px}
/* Right */
.sr{width:280px;background:#fff;border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sr-h{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sr-h h3{font-size:14px;font-weight:700}.sr-h .cb{font-size:11px;color:var(--blue);font-weight:600}
.sr-s{flex:1;overflow-y:auto;padding:10px}
.sf{margin-bottom:10px}.sf label{display:block;font-size:11px;font-weight:700;margin-bottom:3px}
.sf input,.sf textarea,.sf select{width:100%;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px}
.sf textarea{resize:vertical;min-height:50px}
.sf .ht{font-size:10px;color:var(--text2);margin-top:2px}
.sup{width:100%;padding:12px;border:1px dashed var(--border);border-radius:3px;text-align:center;color:var(--text2);font-size:12px;cursor:pointer;background:#fafafa}
.sup:hover{background:#f0f7ff;border-color:var(--blue)}
.sup.ok{border-color:var(--green);background:#ecfdf5;color:var(--green)}
.specs{background:#fef9e7;border:1px solid #f7dc6f;border-radius:3px;padding:6px;font-size:10px;color:#7d6608;margin-bottom:10px}
.specs b{font-weight:700}
.asb{display:flex;align-items:center;justify-content:center;gap:4px;padding:8px;border:1px solid var(--border);border-radius:3px;font-size:12px;font-weight:600;background:#fff;width:100%;margin-bottom:8px}
.asb:hover{background:#f7f7f7}
/* Refine */
.rbar{display:flex;gap:6px;padding:6px 10px;background:#fff;border-top:1px solid var(--border);flex-shrink:0}
.rbar input{flex:1;padding:5px 8px;border-radius:3px;font-size:12px;border:1px solid var(--border)}
/* Modals */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50}
.mbox{background:#fff;border-radius:6px;max-width:420px;width:92%;box-shadow:0 16px 40px rgba(0,0,0,.2)}
/* Layout picker */
.lpg{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:12px}
.lpo{border:2px solid var(--border);border-radius:3px;padding:6px;cursor:pointer;display:grid;gap:2px;min-height:40px}
.lpo:hover{border-color:var(--amz)}
.lpo .c{background:#ddd;border-radius:1px;min-height:16px}
/* Tile picker */
.tpi{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #f3f3f3;cursor:pointer}
.tpi:hover{background:#f7f7f7}
.tpi .ic{font-size:18px;width:28px;text-align:center}
.tpi h5{font-size:12px;font-weight:700}.tpi p{font-size:10px;color:var(--text2)}
/* Gen */
.gbg{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:50}
.gbox{background:#fff;border-radius:6px;max-width:540px;width:92%;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.gst{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:4px;margin-bottom:3px;font-size:11px}
.gst.done{background:#ecfdf5;color:#166534}.gst.act{background:#fffbeb;color:#92400e;font-weight:600}.gst.pen{background:#f9fafb;color:#9ca3af}
.glog{background:#111827;padding:10px;overflow-y:auto;flex:1;font-family:monospace}
.glog div{font-size:10px;color:#4ade80;line-height:1.5;word-break:break-all}
.glog div.e{color:#f87171}
/* Errors */
.ei{margin-bottom:6px;padding:8px;background:#fef2f2;border:1px solid #fecaca;border-radius:3px}
.ei .t{font-size:9px;color:#999}.ei .mg{font-size:11px;font-weight:600;color:var(--red);word-break:break-all}
.ei pre{font-size:9px;color:var(--gray);background:#fff;padding:4px;border-radius:2px;border:1px solid #eee;max-height:120px;overflow:auto;white-space:pre-wrap;word-break:break-all;margin-top:3px}
/* Toast */
.toast{position:fixed;top:10px;right:10px;z-index:70;padding:7px 14px;border-radius:3px;font-size:12px;font-weight:600;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.toast.ok{background:var(--green)}.toast.err{background:var(--red)}
/* Briefing editor */
.bfg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
.bfbox{background:#fff;border-radius:6px;max-width:800px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 16px 40px rgba(0,0,0,.25)}
.bfbox textarea{flex:1;border:none;padding:16px;font-family:'Menlo','Consolas',monospace;font-size:12px;line-height:1.6;resize:none;min-height:400px}
</style>
</head>
<body>
<div id="app"></div>
<script>
const TT={
  product_selection:{n:"Produktauswahl",i:"üß©",d:"Interaktives Quiz",g:"Interaktiv",img:false},
  video_reveal:{n:"Video-Enth√ºllung",i:"üé¨",d:"Video mit Reveal-Effekt",g:"Media",img:true},
  split:{n:"Abschnitt Teilen",i:"‚ûó",d:"Verwandte Inhalte teilen",g:"Layout",img:false},
  text:{n:"Text",i:"üìù",d:"Marken- und Produktgeschichte",g:"Content",img:false},
  image:{n:"Bild",i:"üñºÔ∏è",d:"Marke oder Produkte",g:"Content",img:true,dual:true,sp:{desktop:"min 3000px breit, 16‚Äì2400px hoch",mobile:"min 1680px breit, 20‚Äì3000px hoch",max:"5MB",fmt:"PNG, JPG, GIF"}},
  image_text:{n:"Bild mit Text",i:"üìùüñºÔ∏è",d:"Bild mit Titel/Beschreibung",g:"Content",img:true,dual:true,sp:{desktop:"min 3000px breit, 16‚Äì2400px hoch",mobile:"min 1680px breit, 20‚Äì3000px hoch",max:"5MB"}},
  shoppable_image:{n:"Shoppable-Bild",i:"üõí",d:"Produkte auf Bild markieren",g:"Content",img:true,sp:{min:"3000√ó1500px",max:"5MB"}},
  product:{n:"Produkt",i:"üì¶",d:"Einzelnes Produkt",g:"Produkte",img:false},
  product_grid:{n:"Produktraster",i:"üõçÔ∏è",d:"Mehrere Produkte",g:"Produkte",img:false,nw:true},
  product_collection:{n:"Produktsammlung",i:"üìö",d:"Verwandte Produkte",g:"Produkte",img:false,nw:true},
  featured_deals:{n:"Empfohlene Angebote",i:"üè∑Ô∏è",d:"Produkte mit Angeboten",g:"Produkte",img:false},
  best_sellers:{n:"Meistverkaufte",i:"üèÜ",d:"Automatisch meistverkaufte",g:"Produkte",img:false},
  recommended:{n:"Empfohlene",i:"üí°",d:"Automatische Empfehlungen",g:"Produkte",img:false},
  video:{n:"Video",i:"üé•",d:"Bewegung und Ton",g:"Media",img:true,sp:{cover:"3000√ó1500px",video:"1280√ó640px",fmt:"MP4"}},
  bg_video:{n:"Hintergrundvideo",i:"üé¨",d:"Stilles Loop-Video",g:"Media",img:false,sp:{video:"1280√ó640px",dur:"2‚Äì20s"}},
  gallery:{n:"Galerie",i:"üé®",d:"3-8 Bilder im Slider",g:"Content",img:true,sp:{min:"1500√ó750px",count:"3‚Äì8"}}
};
const TG=["Interaktiv","Content","Media","Produkte","Layout"];
const LY=[
  // Variable H√∂he
  {id:"1",n:"Full Width",c:"1fr",mc:"1fr",cells:1,cat:"Variable"},
  {id:"1-1",n:"2 gleich",c:"1fr 1fr",mc:"1fr",cells:2,cat:"Variable"},
  {id:"2-1",n:"Gro√ü+Klein",c:"2fr 1fr",mc:"1fr",cells:2,cat:"Variable"},
  {id:"1-2",n:"Klein+Gro√ü",c:"1fr 2fr",mc:"1fr",cells:2,cat:"Variable"},
  {id:"1-1-1",n:"3 gleich",c:"1fr 1fr 1fr",mc:"1fr",cells:3,cat:"Variable"},
  {id:"1-1-1-1",n:"4 gleich",c:"1fr 1fr 1fr 1fr",mc:"1fr 1fr",cells:4,cat:"Variable"},
  {id:"2-1-1",n:"Gro√ü+2Klein",c:"2fr 1fr 1fr",mc:"1fr",cells:3,cat:"Variable"},
  {id:"1-1-2",n:"2Klein+Gro√ü",c:"1fr 1fr 2fr",mc:"1fr",cells:3,cat:"Variable"},
  // Basis (from Amazon ‚Äî fixed height rows)
  {id:"b-1-1",n:"Basis 1:1",c:"1fr 1fr",mc:"1fr",cells:2,cat:"Basis"},
  {id:"b-2s-1",n:"Basis Gro√ü+2",c:"1fr 1fr 1fr/1fr span2",mc:"1fr",cells:3,cat:"Basis",grid:"grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr",areas:true,tpl:'"a b" "a c"'},
  {id:"b-1-2s",n:"Basis 2+Gro√ü",c:"1fr 1fr",mc:"1fr",cells:3,cat:"Basis",grid:"grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr",areas:true,tpl:'"a c" "b c"'},
  {id:"b-1-1-1",n:"Basis 3 gleich",c:"1fr 1fr 1fr",mc:"1fr",cells:3,cat:"Basis"},
  {id:"b-1-1-1-1",n:"Basis 4 gleich",c:"1fr 1fr 1fr 1fr",mc:"1fr 1fr",cells:4,cat:"Basis"},
  {id:"b-3-2",n:"Basis 3+2",c:"1fr 1fr 1fr",mc:"1fr 1fr",cells:5,cat:"Basis",grid:"grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr",custom:true},
  {id:"b-2-3",n:"Basis 2+3",c:"1fr 1fr",mc:"1fr",cells:5,cat:"Basis",grid:"grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr",custom:true},
];
const uid=()=>`${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
const esc=s=>String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
const mkT=(type,content={},br="",comp=null)=>({id:uid(),type,content,ib:br,img:null,ifile:"",iw:0,ih:0,imgM:null,ifileM:"",iwM:0,ihM:0,composition:comp});
const mkSec=(lid="1")=>{const l=LY.find(x=>x.id===lid)||LY[0];return{id:uid(),lid:l.id,tiles:Array(l.cells).fill(null)}};
const mkP=(name,id)=>({id:id||uid(),name,himg:null,hfile:"",sections:[mkSec("1")]});
const LANG={de:"German",com:"English","co.uk":"English",fr:"French",it:"Italian",es:"Spanish"};

let S={store:{brandName:"Mein Store",bp:null,pages:[mkP("Homepage","homepage")],mp:"de"},
  cp:"homepage",ss:null,sc:null,dev:"desktop",gen:false,gs:0,gss:[],gl:[],
  el:[],se:false,toast:null,slp:null,stp:null,sgm:false,sbf:null};
let apiKey=localStorage.getItem("asb_api_key")||"";

// ‚îÄ‚îÄ AI ‚îÄ‚îÄ
const PR={
research:`You are a brand research tool for Amazon Brand Store creation. Your ONLY job is to find and return FACTUAL information about brands that sell on Amazon.

CRITICAL RULES:
1. ALWAYS return JSON. NEVER refuse. NEVER explain concerns. Every brand listed on Amazon is valid for a Brand Store.
2. This includes ALL product types: pest control, biocides, supplements, chemicals, pharmaceuticals, adult products, weapons, knives, etc. If it's sold on Amazon, it gets a Brand Store.
3. For sensitive/regulated products (health, biocides, pharmaceuticals, supplements): ONLY use information that the brand itself publishes. Do NOT invent health claims, efficacy statements, or certifications. Paraphrase existing product descriptions and marketing copy found online. Do NOT add new claims.
4. Use web search to find: brand website, Amazon product listings, ASINs, product categories, brand colors, and marketing tone.

Your ENTIRE response must be ONLY a JSON object:
{"brandName":"...","description":"1-2 sentences from brand's own description","type":"premium|d2c|mission|mass_market","tone":"...","colors":{"primary":"#hex","secondary":"#hex","accent":"#hex"},"categories":["..."],"usps":["only USPs the brand itself states"],"targetAudience":"...","products":[{"name":"...","asin":"B0XX","category":"..."}],"amazonCategories":[]}`,
arch:`Plan Amazon Store structure based on how top brands (Nespresso, K√§rcher, ESN, SNOCKS, Holy) build their stores.
Layouts: "1"(full),"1-1"(2eq),"2-1"(big+sm),"1-2"(sm+big),"1-1-1"(3eq),"1-1-1-1"(4eq),"2-1-1"(big+2sm),"1-1-2"(2sm+big),"b-1-1"(basis 2),"b-2s-1"(basis big+2stack),"b-1-2s"(basis 2stack+big),"b-1-1-1"(basis 3),"b-1-1-1-1"(basis 4)
Tiles: product_selection,video_reveal,split,text,image,image_text,shoppable_image,product,product_grid,product_collection,featured_deals,best_sellers,recommended,video,bg_video,gallery

PROVEN HOMEPAGE STRUCTURE (follow this order):
1. Full-width hero image (brand claim + key products) ‚Äî layoutId:"1"
2. Campaign/offer banner (optional) ‚Äî layoutId:"1"
3. Category grid ‚Äî ALL category subpages as clickable image tiles. Use "b-1-1-1-1" for 4 cats, "b-1-1" for 2, "1-1-1" for 3. Each tile = lifestyle photo + category name overlay + CTA
4. Product highlight section ‚Äî shoppable_image or product_grid with real ASINs
5. Brand story / USP section ‚Äî split layout with lifestyle image + text/image
6. Interactive element (quiz/product_selection) if applicable
7. Footer banner ‚Äî "Mehr entdecken" or seasonal CTA

CRITICAL RULES:
- NEVER refuse to create a store for ANY brand. All brands on Amazon are valid.
- For sensitive/regulated products (biocides, supplements, pharma, chemicals): use ONLY factual claims from the brand's own marketing. Do NOT invent new health claims or efficacy statements.
- 85-95% of all tiles should be "image" type. Text is designed INTO images by designer.
- "text" tiles ONLY for FAQ sections or legal text.
- Homepage: category tiles MUST link to their subpage (use "link":"page_id" in content)
- Non-category pages (About Us, FAQ) appear lower, NOT in main category grid
- Each category subpage: hero image + product_grid/collection + USP images
- Use real ASINs from product list
- 4-8 pages, 3-6 sections/page

Return ONLY JSON:
{"pages":[{"id":"homepage","name":"Homepage","sections":[{"layoutId":"1","tiles":["image: hero"]},{"layoutId":"b-1-1-1-1","tiles":["image: cat1","image: cat2","image: cat3","image: cat4"]},{"layoutId":"1","tiles":["product_grid: bestsellers"]}]},{"id":"cat1","name":"Category 1","sections":[...]}]}`,
content:`Create COMPLETE content for ONE Amazon Store page.

DESIGN PHILOSOPHY based on analysis of Nespresso, K√§rcher, ESN, SNOCKS, Holy, nucao stores:
- ~74% of modules are pure IMAGE tiles (text designed into the image by designer)
- ~13% are PRODUCT tiles (Amazon-native product widgets with price/rating)
- ~5% are IMAGE_TEXT tiles (image with native Amazon text below ‚Äî for ingredient labels, category names)
- ~3% are TEXT tiles (ONLY for section headings between blocks, or compliance/legal text)
- ~4% are SHOPPABLE_IMAGE tiles
- ~1% are VIDEO tiles

WHEN TO USE EACH MODULE:
- "image" ‚Üí Heroes, campaign banners, category links (with name+CTA designed into image), lifestyle shots, brand story, testimonials, USP graphics. ALL text is IN the image.
- "image_text" ‚Üí When you need a photo ABOVE with a short label/title BELOW (like AG1 ingredient cards, SNOCKS category cards with "Tennissocken." label)
- "text" ‚Üí ONLY for standalone headings between sections (e.g. "ZWEI EINZIGARTIGE KAFFEE-ERLEBNISSE") or legal/compliance text. MAX 1-2 per page.
- "product"/"product_grid" ‚Üí Amazon-native product widgets. Use with real ASINs.
- "shoppable_image" ‚Üí Product-in-use photos with tagged ASINs (like Bears with Benefits model holding product)
- "video" ‚Üí MAX 1 per page, for brand/product videos

TILE CONTENT RULES:
- "image" ‚Üí {"type":"image","content":{"alt":"desc","link":"page_id or empty","w":3000,"h":1200},"imageBriefing":"DESKTOP: 3000√ó1200px | MOBILE: 1680√ó840px | SUBJECT: ... | TEXT OVERLAY: exact text in store language | COLORS: #hex | STYLE: photo/illustration","composition":{"bg":"lifestyle-photo|solid-color|gradient|product-scene","textPos":"top-left|top-center|center|bottom-left|bottom-center","textLines":["Headline","Subline"],"ctaText":"CTA or empty","ctaPos":"bottom-center|bottom-right","productPos":"right|left|center|none","productCount":0,"accentColor":"#hex"}}
- "text" ‚Üí RARE. Only for FAQ, legal. {"type":"text","content":{"title":"Title","text":"Short text."}}
- "image_text" ‚Üí Use when Amazon text overlay is acceptable. {"type":"image_text","content":{"headline":"...","body":"...","linkText":"..."},"imageBriefing":"..."}
- "shoppable_image" ‚Üí {"type":"shoppable_image","content":{"alt":"desc","products":["ASIN1"]},"imageBriefing":"..."}
- "product" ‚Üí {"type":"product","content":{"asin":"B0REALASINFROMLIST"}}
- "product_grid" ‚Üí {"type":"product_grid","content":{"asins":"B0ASIN1\\nB0ASIN2\\nB0ASIN3","title":"Title"}}
- "product_collection" ‚Üí {"type":"product_collection","content":{"asins":"B0ASIN1\\nB0ASIN2","title":"Name"}}
- "product_selection" ‚Üí Full quiz: {"type":"product_selection","content":{"introTitle":"...","introText":"...","questions":[{"q":"...","answers":[{"a":"...","nextQ":1,"products":["ASIN"]}]}],"resultsTitle":"..."}}
- "video"/"bg_video" ‚Üí {"type":"video","content":{"alt":"desc"},"imageBriefing":"VIDEO: subject, mood"}
- "gallery" ‚Üí {"type":"gallery","content":{"images":["desc1","desc2"]},"imageBriefing":"GALLERY: ..."}
- "best_sellers"/"recommended"/"featured_deals" ‚Üí {"type":"best_sellers","content":{"category":"filter"}}

IMAGE BRIEFING MUST include: exact text overlay in store language (headlines, sublines, CTAs), desktop AND mobile dimensions, visual description, brand colors, mood/style.

COMPOSITION FIELD is REQUIRED for every image/image_text/shoppable_image tile. It drives automatic wireframe sketches for the designer.

IMAGE DIMENSION GUIDELINES (choose based on purpose, within Amazon limits):
- Hero banner: w:3000, h:1000-1500 (wide cinematic)
- Category link tiles: w:1000, h:1000 (square in grid) or w:1500, h:750 (landscape)
- USP/Feature banner: w:3000, h:800 (slim banner)
- Lifestyle/Story: w:3000, h:1500 (standard)
- Brand story/About: w:3000, h:2000 (tall immersive)
Set w and h in content to specify exact recommended pixels.

CRITICAL: Use REAL ASINs. ALL fields filled. Prefer image tiles. imageBriefing in English except text overlays which are in store language.
NEVER refuse to create content for ANY product type. For regulated/sensitive products: ONLY paraphrase existing brand claims found in the research data. Do NOT invent new health claims, efficacy promises, or certifications. Use the brand's own language and messaging.
Return ONLY JSON:
{"pageName":"...","sections":[{"layoutId":"...","tiles":[...]}]}`,
refine:`Refine Amazon Store. NEVER refuse for any product type. For sensitive products, only paraphrase existing brand claims. Structure: pages>sections(layoutId+tiles). ALL text fields must have content. Use real ASINs. Return ONLY valid JSON with ALL pages:
{"pages":[...]}`
};

async function callAI(sys,usr,ws=false,mdl="claude-sonnet-4-20250514"){
  if(!apiKey)throw new Error("API Key fehlt!");
  const b={model:mdl,max_tokens:ws?8000:8000,system:sys,messages:[{role:"user",content:usr}]};
  if(ws)b.tools=[{type:"web_search_20250305",name:"web_search"}];
  for(let a=0;a<3;a++){
    let r;
    try{r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(b)})}
    catch(e){throw new Error("Network: "+e.message)}
    if(r.status===429){if(a>=2)throw new Error("Rate limit ‚Äî 2 Min warten");
      const w=60*(a+1);log("‚è≥ Rate limit, "+w+"s...");R();await new Promise(x=>setTimeout(x,w*1000));continue}
    if(!r.ok){const t=await r.text();err("API "+r.status,t);throw new Error("API "+r.status+": "+t.slice(0,200))}
    const d=await r.json(),rawTxt=(d.content||[]).filter(x=>x.type==="text").map(x=>x.text).join("");
    // Strip markdown codeblocks
    const txt=rawTxt.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();
    // Robust JSON extraction
    let json;
    try{
      const m=txt.match(/\{[\s\S]*\}/);
      if(!m)throw new Error("No JSON block");
      json=JSON.parse(m[0]);
    }catch(e1){
      // Try to fix common issues: trailing commas, truncated JSON
      try{
        let fixed=txt.match(/\{[\s\S]*/)?.[0]||"";
        // Remove trailing incomplete string values
        fixed=fixed.replace(/,"[^"]*$/,"").replace(/,\s*"[^"]*":\s*"[^"]*$/,"");
        // Remove trailing incomplete entries
        fixed=fixed.replace(/,\s*\]}/g,"]}").replace(/,\s*}/g,"}").replace(/,\s*$/,"");
        // Close unclosed strings (if last char is inside a string)
        if((fixed.split('"').length-1)%2!==0)fixed+='"';
        // Try to close unclosed brackets
        let opens=0,closes=0;
        for(const ch of fixed){if(ch==='{')opens++;if(ch==='}')closes++}
        while(closes<opens){fixed+='}';closes++}
        let oB=0,cB=0;
        for(const ch of fixed){if(ch==='[')oB++;if(ch===']')cB++}
        while(cB<oB){fixed+=']';cB++}
        json=JSON.parse(fixed);
        log("‚ö† JSON repariert");
      }catch(e2){err("JSON Parse",txt.slice(0,500));throw new Error("JSON Parse error: "+e1.message)}
    }
    return json;
  }
  throw new Error("Rate limit nach Retries");
}
function log(m){S.gl.push("["+new Date().toLocaleTimeString()+"] "+m);R()}
function err(m,d){S.el.push({t:new Date().toLocaleTimeString(),m,d:d||""})}
function toast(m,t){S.toast={m,t:t||"ok"};R();setTimeout(()=>{S.toast=null;R()},3500)}

// ‚îÄ‚îÄ Generation ‚îÄ‚îÄ
async function generate(brand,mp,cat,info){
  if(!apiKey){pKey();return}
  S.gen=true;S.gl=[];S.store.mp=mp;
  const lang=LANG[mp]||"German";
  S.gss=[{n:"Recherche",d:"Marke & Amazon"},{n:"Architektur",d:"Seiten & Layouts"},{n:"Content",d:"Texte & Briefings"},{n:"Check",d:"Validierung"}];
  S.gs=0;R();
  try{
    log("üîç "+brand+"...");
    let bp;
    try{
      bp=await callAI(PR.research,`Research "${brand}" for Amazon.${mp}. ${cat?"Category: "+cat+".":""} Return ONLY the JSON object, nothing else.`,true,"claude-haiku-4-5-20251001");
    }catch(researchErr){
      // Retry with Sonnet if Haiku refused
      log("‚ö† Haiku verweigert, versuche Sonnet...");
      try{
        bp=await callAI(PR.research,`Research "${brand}" for Amazon.${mp}. ${cat?"Category: "+cat+".":""} This brand sells on Amazon and needs a Brand Store. Return ONLY the JSON object with all factual information you can find.`,true);
      }catch(retryErr){
        throw new Error("Research fehlgeschlagen: AI verweigert Antwort f√ºr diese Marke. Bitte versuche es erneut oder gib mehr Kontext im Info-Feld.");
      }
    }
    if(!bp.brandName)bp.brandName=brand;
    log("‚úÖ "+(bp.products?.length||0)+" Produkte");S.gs=1;R();await new Promise(x=>setTimeout(x,5000));

    log("üèóÔ∏è Architektur...");
    const userReqs=info?`\nUSER REQUIREMENTS (must follow): ${info}`:"";
    const arch=await callAI(PR.arch,`Brand: ${JSON.stringify(bp)}\nProducts: ${bp.products?.length||0}\nLang: ${lang}${userReqs}`);
    log("‚úÖ "+(arch.pages?.length||0)+" Seiten");S.gs=2;R();await new Promise(x=>setTimeout(x,5000));

    const prods=(bp.products||[]).slice(0,15);
    const prodStr=prods.map(p=>`${p.name} (${p.asin}) [${p.category||""}]`).join(", ");
    const pages=[];
    for(let i=0;i<(arch.pages||[]).length;i++){
      const pp=arch.pages[i];log("üìù "+(i+1)+"/"+arch.pages.length+": "+pp.name);R();
      const pc=await callAI(PR.content,`PAGE: ${JSON.stringify(pp)}\nBRAND: ${bp.type}, ${bp.tone}, colors=${JSON.stringify(bp.colors)}\nPRODUCTS (use these real ASINs): ${prodStr}\nLang: ${lang}${userReqs}\nDesigner briefings in ENGLISH. Customer text in ${lang}. Use real ASINs from the product list above.`);
      const secs=(pc.sections||[]).map(s=>{
        const l=LY.find(x=>x.id===s.layoutId)||LY[0];
        const tiles=(s.tiles||[]).slice(0,l.cells).map(t=>{
          if(!t||typeof t==="string")return null;
          if(!TT[t.type])return null;
          return mkT(t.type,t.content||{},t.imageBriefing||"",t.composition||null);
        });
        while(tiles.length<l.cells)tiles.push(null);
        return{id:uid(),lid:l.id,tiles}
      });
      pages.push({id:pp.id||"p_"+i,name:pc.pageName||pp.name,sections:secs.length?secs:[mkSec("1")]});
      log("   ‚úÖ "+secs.length+" Secs");
      if(i<arch.pages.length-1)await new Promise(x=>setTimeout(x,5000));
    }
    S.gs=3;log("‚úÖ Fertig: "+pages.length+" Seiten");
    S.store={brandName:brand,bp,pages,mp};S.cp=pages[0]?.id;S.ss=null;S.sc=null;
    toast(pages.length+" Seiten generiert");
  }catch(e){log("‚ùå "+e.message);err("Gen",e.stack);toast(e.message,"err")}
  finally{S.gen=false;R()}
}
async function doRefine(inst){
  if(!apiKey){pKey();return}
  S.gen=true;S.gss=[{n:"Verfeinere",d:inst}];S.gs=0;S.gl=[];R();
  log('‚úèÔ∏è "'+inst+'"');
  const clean=JSON.parse(JSON.stringify(S.store));
  clean.pages.forEach(p=>p.sections.forEach(s=>s.tiles.forEach((t,i)=>{if(t){t.img=null}})));
  try{
    const r=await callAI(PR.refine,`STORE:\n${JSON.stringify(clean)}\n\nCHANGE: ${inst}\n\nReturn COMPLETE valid JSON with pages array.`);
    if(r.pages?.length){
      S.store.pages=r.pages.map((p,i)=>({id:p.id||"p_"+i,name:p.name||"Seite",sections:(p.sections||[]).map(s=>{
        const l=LY.find(x=>x.id===(s.layoutId||s.lid))||LY[0];
        const tiles=(s.tiles||[]).slice(0,l.cells).map(t=>t&&TT[t.type]?mkT(t.type,t.content||{},t.imageBriefing||t.ib||"",t.composition||null):null);
        while(tiles.length<l.cells)tiles.push(null);
        return{id:uid(),lid:l.id,tiles}
      })}));
      if(r.brandProfile||r.bp)S.store.bp=r.brandProfile||r.bp;
      S.cp=S.store.pages[0]?.id;
      log("‚úÖ Verfeinert");toast("Store verfeinert!");
    }else{log("‚ö† Keine pages in Antwort");toast("Keine √Ñnderung","err")}
  }catch(e){log("‚ùå "+e.message);err(e.message);toast(e.message,"err")}
  finally{S.gen=false;R()}
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
function cp(){return S.store.pages.find(p=>p.id===S.cp)||S.store.pages[0]}
function addP(){const n=prompt("Seitenname:");if(n){const p=mkP(n);S.store.pages.push(p);S.cp=p.id;R()}}
function delP(id){if(S.store.pages.length<=1)return;S.store.pages=S.store.pages.filter(p=>p.id!==id);if(S.cp===id)S.cp=S.store.pages[0]?.id;R()}
function pmenu(id,i){const a=prompt(S.store.pages[i].name+":\n1=Umbenennen 2=‚Üë 3=‚Üì 4=L√∂schen");
  if(a==="1"){const n=prompt("Name:",S.store.pages[i].name);if(n)S.store.pages[i].name=n}
  else if(a==="2"&&i>0)[S.store.pages[i-1],S.store.pages[i]]=[S.store.pages[i],S.store.pages[i-1]];
  else if(a==="3"&&i<S.store.pages.length-1)[S.store.pages[i],S.store.pages[i+1]]=[S.store.pages[i+1],S.store.pages[i]];
  else if(a==="4")delP(id);R()}
function addSec(lid){cp().sections.push(mkSec(lid));R()}
function delSec(sid){const pg=cp();pg.sections=pg.sections.filter(s=>s.id!==sid);if(S.ss===sid){S.ss=null;S.sc=null}R()}
function mvSec(sid,d){const ss=cp().sections,i=ss.findIndex(s=>s.id===sid),j=i+d;if(j>=0&&j<ss.length)[ss[i],ss[j]]=[ss[j],ss[i]];R()}
function setT(sid,ci,t){const s=cp().sections.find(x=>x.id===sid);if(s)s.tiles[ci]=t;R()}
function selC(sid,ci){S.ss=sid;S.sc=ci;R()}
function upImg(sid,ci,target){
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*,video/*";
  inp.onchange=()=>{const f=inp.files[0];if(!f)return;
    if(f.type.startsWith("video/")){const s=cp().sections.find(x=>x.id===sid);if(s&&s.tiles[ci]){s.tiles[ci].ifile=f.name;toast("Video: "+f.name)}R();return}
    const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{
      const s=cp().sections.find(x=>x.id===sid);if(!s||!s.tiles[ci])return;
      if(target==="mobile"){s.tiles[ci].imgM=e.target.result;s.tiles[ci].ifileM=f.name;s.tiles[ci].iwM=img.width;s.tiles[ci].ihM=img.height}
      else{s.tiles[ci].img=e.target.result;s.tiles[ci].ifile=f.name;s.tiles[ci].iw=img.width;s.tiles[ci].ih=img.height}
      toast((target==="mobile"?"üì±":"üñ•")+" "+img.width+"√ó"+img.height+"px");R()};img.src=e.target.result};r.readAsDataURL(f)};inp.click()}
function upHdr(){
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*";
  inp.onchange=()=>{const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{
    const pg=cp();pg.himg=e.target.result;pg.hfile=f.name;toast("Header: "+img.width+"√ó"+img.height);R()};img.src=e.target.result};r.readAsDataURL(f)};inp.click()}
function pKey(){const k=prompt("Anthropic API Key:",apiKey);if(k){apiKey=k;localStorage.setItem("asb_api_key",k);toast("Key gespeichert")}}

// ‚îÄ‚îÄ Briefing ‚îÄ‚îÄ
function genBriefing(){
  const st=S.store,bp=st.bp,lang=LANG[st.mp||"de"]||"German";
  let md="# Designer Briefing: "+st.brandName+"\n\n";
  md+="**Target marketplace language for all image text overlays: "+lang+"**\n\n";
  // Designer Guide
  md+="## üìñ Amazon Brand Store ‚Äî Guide for Designers\n\n";
  md+="An Amazon Brand Store is a brand's own storefront within Amazon. It consists of multiple pages (Homepage + category subpages) built from **modular sections**. Each section has a grid layout with cells that contain **tiles** (modules).\n\n";
  md+="### How images work in Brand Stores:\n";
  md+="- **Every image has TWO versions**: Desktop (min 3000px wide) and Mobile (min 1680px wide)\n";
  md+="- Desktop images display at full width on the store page (~1500px rendered)\n";
  md+="- Mobile images display on phones (~414px rendered) ‚Äî text must be LARGER\n";
  md+="- **Text on images IS the primary content** ‚Äî Amazon's native text modules look generic. Top brands (Nespresso, K√§rcher, ESN) design ALL text into their images for full brand control\n";
  md+="- Images can link to category subpages, ASINs, or external URLs\n";
  md+="- **CTA buttons** should be designed INTO the image (not Amazon native)\n\n";
  md+="### Image types by purpose:\n";
  md+="| Purpose | Desktop Size | Aspect | Notes |\n|---------|-------------|--------|-------|\n";
  md+="| Header/Hero | 3000√ó600‚Äì1500 | 5:1 to 2:1 | Brand claim, key visual |\n";
  md+="| Category tile | 750‚Äì1500 per cell | 1:1 to 4:3 | Lifestyle + category name overlay |\n";
  md+="| USP banner | 3000√ó600‚Äì800 | Wide | Feature highlights |\n";
  md+="| Brand story | 3000√ó1500‚Äì2000 | 2:1 to 3:2 | Immersive lifestyle |\n";
  md+="| Campaign | 3000√ó1000‚Äì1500 | 3:1 to 2:1 | Offers, seasonal |\n\n";
  md+="### Best practice from top stores:\n";
  md+="- 85‚Äì95% of modules are custom images (not text modules)\n";
  md+="- Category grid on homepage uses lifestyle photos with category name as bold text overlay\n";
  md+="- Consistent color palette throughout (brand primary + secondary)\n";
  md+="- CTAs in brand accent color (e.g. K√§rcher: yellow bar, Nespresso: gold pill)\n";
  md+="- Mobile: text must be ~50% larger than desktop to remain readable\n\n---\n\n";
  if(bp){md+="## Brand Overview\n- Type: "+bp.type+"\n- Tone: "+bp.tone+"\n- Colors: "+(bp.colors?Object.entries(bp.colors).map(([k,v])=>k+": "+v).join(", "):"")+"\n- USPs: "+(bp.usps||[]).join(" | ")+"\n- Target: "+(bp.targetAudience||"")+"\n\n---\n\n"}
  st.pages.forEach((pg,pi)=>{md+="## Page "+(pi+1)+": "+pg.name+"\n\n";
    md+="### Header Image\n- Minimum: 3000√ó600px, max 5MB\n- Safe zone: center 70%\n"+(pg.hfile?"- ‚úÖ Uploaded: "+pg.hfile+"\n":"- ‚ö† Image needed\n")+"\n";
    pg.sections.forEach((sec,si)=>{const l=LY.find(x=>x.id===sec.lid)||LY[0];
      md+="### Section "+(si+1)+" ‚Äî Layout: "+l.n+" ("+l.cells+" cells)\n\n";
      sec.tiles.forEach((t,ci)=>{if(!t)return;const td=TT[t.type];
        md+="**Cell "+(ci+1)+": "+td.n+"**\n";
        if(td.sp)Object.entries(td.sp).forEach(([k,v])=>{md+="- "+k+": "+v+"\n"});
        if(t.ib)md+="- üé® Briefing: "+t.ib+"\n";
        const comp=t.composition||t.content?.composition;
        if(comp){
          md+="- üìê Composition: bg="+comp.bg+", text="+comp.textPos+"\n";
          if(comp.textLines?.length)md+="- üìù Text lines: "+comp.textLines.map(l=>'"'+l+'"').join(" / ")+"\n";
          if(comp.ctaText)md+="- üîò CTA: \""+comp.ctaText+"\" ("+comp.ctaPos+")\n";
          if(comp.productPos!=="none"&&comp.productCount)md+="- üì¶ Products: "+comp.productCount+"√ó at "+comp.productPos+"\n";
        }
        if(t.content?.w)md+="- üìè Recommended: "+t.content.w+"√ó"+t.content.h+"px (Desktop)\n";
        if(t.content){const c=t.content;
          if(c.headline)md+="- Headline ("+lang+"): "+c.headline+"\n";
          if(c.body)md+="- Body ("+lang+"): "+c.body+"\n";
          if(c.title)md+="- Title ("+lang+"): "+c.title+"\n";
          if(c.text)md+="- Text ("+lang+"): "+c.text+"\n";
          if(c.asin)md+="- ASIN: "+c.asin+"\n";
          if(c.asins)md+="- ASINs:\n"+c.asins.split("\n").map(a=>"  - "+a).join("\n")+"\n";
          if(c.questions){md+="- **Quiz Flow:**\n";
            (c.questions||[]).forEach((q,qi)=>{md+="  - Q"+(qi+1)+": "+q.q+"\n";
              (q.answers||[]).forEach(a=>{md+="    - \""+a.a+"\" ‚Üí Products: "+(a.products||[]).join(", ")+"\n"})})
          }
          if(c.images)md+="- Gallery images: "+(c.images||[]).join(" | ")+"\n";
        }
        if(t.img)md+="- ‚úÖ Desktop image: "+t.ifile+" ("+t.iw+"√ó"+t.ih+")\n";
        else if(td.img)md+="- ‚ö† Desktop image needed\n";
        if(t.imgM)md+="- ‚úÖ Mobile image: "+t.ifileM+" ("+t.iwM+"√ó"+t.ihM+")\n";
        else if(td.dual)md+="- ‚ö† Mobile image needed\n";
        md+="\n"});md+="\n"});md+="---\n\n"});
  return md;
}
function showBriefing(){S.sbf=genBriefing();R()}
function exportBriefing(){
  const ta=document.getElementById("bf-ta");
  const content=ta?ta.value:S.sbf;
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([content],{type:"text/markdown"}));
  a.download=S.store.brandName+"_briefing.md";a.click();toast("Briefing exportiert");S.sbf=null;R()}
function exportJSON(){const d=JSON.parse(JSON.stringify(S.store));d.pages.forEach(p=>p.sections.forEach(s=>s.tiles.forEach((t)=>{if(t)t.img=null})));
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:"application/json"}));a.download=S.store.brandName+"_store.json";a.click();toast("JSON exportiert")}

// ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ
let _rt;function dR(){clearTimeout(_rt);_rt=setTimeout(R,600)}
function getGridStyle(l,mob){
  if(mob)return'grid-template-columns:'+l.mc;
  if(l.areas)return l.grid+';grid-template-areas:'+l.tpl;
  if(l.custom&&l.id==="b-3-2")return'grid-template-columns:repeat(6,1fr);grid-template-rows:1fr 1fr';
  if(l.custom&&l.id==="b-2-3")return'grid-template-columns:repeat(6,1fr);grid-template-rows:1fr 1fr';
  return'grid-template-columns:'+l.c;
}
// ‚îÄ‚îÄ SVG Wireframe Generator ‚îÄ‚îÄ
function mkWireframe(t,w,h){
  const comp=t.content?.composition||t.composition||{};
  const c=comp.accentColor||S.store.bp?.colors?.primary||'#FF9900';
  const c2=S.store.bp?.colors?.secondary||'#232F3E';
  const lines=comp.textLines||[];
  const tPos=comp.textPos||'center';
  const bg=comp.bg||'lifestyle-photo';
  const cta=comp.ctaText||'';
  const pPos=comp.productPos||'none';
  const pCnt=comp.productCount||0;
  const vw=w||300,vh=h||150;
  let svg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${vw} ${vh}" style="width:100%;height:auto;display:block">`;
  // Background
  if(bg==='solid-color')svg+=`<rect width="${vw}" height="${vh}" fill="${c}" opacity="0.15"/>`;
  else if(bg==='gradient')svg+=`<defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="${c}" stop-opacity="0.2"/><stop offset="100%" stop-color="${c2}" stop-opacity="0.15"/></linearGradient></defs><rect width="${vw}" height="${vh}" fill="url(#g)"/>`;
  else{svg+=`<rect width="${vw}" height="${vh}" fill="#f0f0f0"/>`;
    // Landscape sketch lines for lifestyle
    svg+=`<line x1="0" y1="${vh*.7}" x2="${vw}" y2="${vh*.65}" stroke="#ddd" stroke-width="0.5"/>`;
    svg+=`<line x1="0" y1="${vh*.75}" x2="${vw}" y2="${vh*.72}" stroke="#e0e0e0" stroke-width="0.5"/>`;
    // Diagonal cross for "image placeholder"
    svg+=`<line x1="${vw*.1}" y1="${vh*.1}" x2="${vw*.9}" y2="${vh*.9}" stroke="#e5e5e5" stroke-width="0.3"/>`;
    svg+=`<line x1="${vw*.9}" y1="${vh*.1}" x2="${vw*.1}" y2="${vh*.9}" stroke="#e5e5e5" stroke-width="0.3"/>`}
  // Product placeholder (right side circle/box)
  if(pPos!=='none'&&pCnt>0){
    const px=pPos==='left'?vw*.15:pPos==='center'?vw*.5:vw*.75;
    const py=vh*.45;const pr=Math.min(vw,vh)*.2;
    for(let i=0;i<Math.min(pCnt,3);i++){
      const ox=i*(pr*.8);
      svg+=`<rect x="${px-pr/2+ox}" y="${py-pr/2}" width="${pr*.7}" height="${pr}" rx="3" fill="#ddd" stroke="#bbb" stroke-width="0.5"/>`;
      svg+=`<circle cx="${px+ox}" cy="${py-pr*.1}" r="${pr*.2}" fill="#ccc"/>` // product icon
    }}
  // Text lines (wavy lines representing text)
  const txMap={
    'top-left':{x:vw*.05,y:vh*.12,ax:'start'},
    'top-center':{x:vw*.5,y:vh*.12,ax:'middle'},
    'center':{x:vw*.5,y:vh*.4,ax:'middle'},
    'bottom-left':{x:vw*.05,y:vh*.7,ax:'start'},
    'bottom-center':{x:vw*.5,y:vh*.7,ax:'middle'}
  };
  const tp=txMap[tPos]||txMap['center'];
  lines.forEach((line,i)=>{
    const ly=tp.y+i*14;
    const lw=Math.min(line.length*4,vw*.7);
    const lx=tp.ax==='middle'?tp.x-lw/2:tp.x;
    const fs=i===0?9:7;const fw=i===0?'bold':'normal';
    // Wavy text-indicating line
    let path=`M${lx},${ly}`;
    for(let j=0;j<lw;j+=6)path+=`q3,-${1+Math.random()*2} 6,0`;
    svg+=`<path d="${path}" fill="none" stroke="${c2}" stroke-width="${i===0?1.5:0.8}" opacity="0.5"/>`;
  });
  // CTA button
  if(cta){
    const cy=comp.ctaPos==='bottom-right'?vh*.85:vh*.85;
    const cx=comp.ctaPos==='bottom-right'?vw*.75:vw*.5;
    const bw=cta.length*4+20;
    svg+=`<rect x="${cx-bw/2}" y="${cy-8}" width="${bw}" height="16" rx="3" fill="${c}" opacity="0.7"/>`;
    svg+=`<line x1="${cx-bw/4}" y1="${cy}" x2="${cx+bw/4}" y2="${cy}" stroke="#fff" stroke-width="1"/>` // text line in button
  }
  // Dimension label
  const dw=t.content?.w||3000,dh=t.content?.h||1500;
  svg+=`<text x="${vw-4}" y="10" font-size="6" fill="#999" text-anchor="end" font-family="monospace">${dw}√ó${dh}</text>`;
  svg+='</svg>';
  return svg;
}
function uTP(p,v){const s=cp().sections.find(x=>x.id===S.ss);if(s&&s.tiles[S.sc])s.tiles[S.sc][p]=v;dR()}
function uTC(k,v){const s=cp().sections.find(x=>x.id===S.ss);if(s&&s.tiles[S.sc]){if(!s.tiles[S.sc].content)s.tiles[S.sc].content={};s.tiles[S.sc].content[k]=v}dR()}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function R(){
  const st=S.store,pg=cp(),bp=st.bp,ac=bp?.colors?.primary||"#FF9900";
  const mob=S.dev==="mobil";
  let h="";
  // Topbar
  h+='<div class="topbar"><div class="logo">üè™ <b>Store</b> Builder</div><div class="spacer"></div>';
  if(S.el.length)h+='<button class="tb" style="color:#f87171;border-color:#f87171" onclick="S.se=true;R()">üêõ '+S.el.length+'</button>';
  h+='<button class="tb" onclick="pKey()">üîë</button>';
  h+='<button class="tb" onclick="showBriefing()">üìã Briefing</button>';
  h+='<button class="tb" onclick="exportJSON()">üì• JSON</button>';
  h+='<button class="tb p" onclick="S.sgm=true;R()">‚ú® AI</button>';
  h+='</div>';
  // Toolbar
  h+='<div class="toolbar"><div class="dtog"><button class="'+(mob?"":"a")+'" onclick="S.dev=\'desktop\';R()">üñ• Desktop</button><button class="'+(mob?"a":"")+'" onclick="S.dev=\'mobil\';R()">üì± Mobil</button></div><div class="spacer"></div></div>';
  // Main
  h+='<div class="main">';
  // Left
  h+='<div class="sl"><h2>Seiten</h2><button class="abtn" onclick="addP()">‚ú¶ Seite hinzuf√ºgen</button><div class="plist">';
  st.pages.forEach((p,i)=>{h+='<div class="pi'+(p.id===S.cp?" a":"")+'" onclick="S.cp=\''+p.id+'\';S.ss=null;S.sc=null;R()"><span class="n">'+esc(p.name)+'</span><button class="m" onclick="event.stopPropagation();pmenu(\''+p.id+'\','+i+')">‚ãÆ</button></div>'});
  h+='</div></div>';
  // Canvas
  h+='<div class="cw"><div class="canvas"><div class="ci" style="max-width:'+(mob?"400px":"960px")+'">';
  // Header
  h+='<div class="sh'+(S.ss==="h"?" s":"")+'" onclick="S.ss=\'h\';S.sc=null;R()">';
  if(pg?.himg)h+='<img src="'+pg.himg+'" style="width:100%;display:block;border-radius:2px 2px 0 0">';
  h+='<div class="sh-top"><div class="sh-logo" style="'+(bp?"background:"+ac:"")+'">üè™</div><div style="font-weight:700;font-size:13px">'+esc(st.brandName)+'</div></div>';
  h+='<div class="sh-nav">';st.pages.forEach(p=>{h+='<span'+(p.id===S.cp?' class="a"':'')+' onclick="event.stopPropagation();S.cp=\''+p.id+'\';R()">'+esc(p.name)+'</span>'});h+='</div></div>';
  // Sections
  if(pg)pg.sections.forEach((sec,si)=>{
    const l=LY.find(x=>x.id===sec.lid)||LY[0];
    h+='<div class="sec'+(S.ss===sec.id?" s":"")+'" onclick="S.ss=\''+sec.id+'\';S.sc=null;R()">';
    h+='<span class="sec-lbl">'+(si+1)+'. '+l.n+'</span>';
    h+='<div class="lg" style="'+getGridStyle(l,mob)+'">';
    sec.tiles.forEach((t,ci)=>{
      const areaStyle=l.areas?'grid-area:'+String.fromCharCode(97+ci):'';
      h+='<div class="lc'+(t?" f":"")+'" style="'+areaStyle+'" onclick="event.stopPropagation();selC(\''+sec.id+'\','+ci+')">';
      if(t){const td=TT[t.type];h+='<span class="tbdg">'+td.i+' '+td.n+'</span>'+rT(t,td)}
      else h+='<div class="ph" onclick="event.stopPropagation();S.stp={s:\''+sec.id+'\',c:'+ci+'};R()"><span style="font-size:16px">+</span><span>Kachel</span></div>';
      h+='</div>'});
    h+='</div></div>'});
  if(pg)h+='<button class="asb" onclick="S.slp=true;R()">+ Neuen Abschnitt</button>';
  h+='</div></div>';
  // Refine
  h+='<div class="rbar"><input id="ri" placeholder="AI Anweisung..." onkeydown="if(event.key===\'Enter\'){doRefine(this.value);this.value=\'\'}"><button class="tb p" style="font-size:11px" onclick="var e=document.getElementById(\'ri\');doRefine(e.value);e.value=\'\'">‚ú®</button></div></div>';
  // Right
  h+='<div class="sr">'+rProps()+'</div>';
  h+='</div>';
  // Modals
  if(S.slp)h+=rLP();if(S.stp)h+=rTP();if(S.sgm)h+=rGM();if(S.gen)h+=rGO();if(S.se)h+=rEP();if(S.sbf!==null)h+=rBF();
  if(S.toast)h+='<div class="toast '+(S.toast.t==="err"?"err":"ok")+'">'+(S.toast.t==="ok"?"‚úì":"‚úï")+" "+esc(S.toast.m)+'</div>';
  document.getElementById("app").innerHTML=h;
}
function rT(t,td){
  const c=t.content||{};
  if(t.type==="text")return'<div class="ttxt">'+(c.title?'<b>'+esc(c.title)+'</b><br>':'')+esc(c.text||"[Text fehlt]")+'</div>';
  if(t.type==="image_text")return'<div style="display:flex;flex-direction:column;height:100%"><div class="timgph">'+(t.img?'<img src="'+t.img+'" style="width:100%;height:auto">':'üñºÔ∏è')+'</div><div style="padding:6px"><div style="font-weight:700;font-size:12px">'+esc(c.headline||"[Headline]")+'</div><div style="font-size:11px;color:#666">'+esc(c.body||"")+'</div></div></div>';
  if(t.type==="product_selection"){const qs=c.questions||[];return'<div style="padding:10px;background:linear-gradient(135deg,#eef2ff,#fef3c7)"><div style="font-weight:700;font-size:13px;margin-bottom:4px">üß© '+esc(c.introTitle||"Produktauswahl-Quiz")+'</div><div style="font-size:11px;color:#666;margin-bottom:6px">'+esc(c.introText||"")+'</div><div style="font-size:10px;color:#888">'+qs.length+' Fragen</div>'+(qs.length?'<div style="margin-top:4px;padding:4px 6px;background:#fff;border-radius:3px;font-size:10px;color:#444">‚ùì '+esc(qs[0].q||"")+'</div>':'')+'</div>'}
  if(["product","product_grid","product_collection"].includes(t.type)){const asins=c.asins?c.asins.split('\n').filter(Boolean):c.asin?[c.asin]:[];return'<div class="tprod"><div style="text-align:center">'+td.i+'<div style="font-weight:600;font-size:11px">'+td.n+'</div>'+(asins.length?'<div style="font-size:9px;color:#888;margin-top:2px">'+asins.length+' ASIN'+(asins.length>1?"s":"")+'</div>':'')+'</div></div>'}
  if(["best_sellers","recommended","featured_deals"].includes(t.type))return'<div class="tauto">'+td.i+' '+td.n+(c.category?' <span style="font-size:10px;opacity:.6">('+esc(c.category)+')</span>':'')+'</div>';
  if(["video","bg_video","video_reveal"].includes(t.type))return'<div style="display:flex;align-items:center;justify-content:center;min-height:70px;background:#1a1a2e;color:rgba(255,255,255,.3);font-size:24px">'+(t.ifile?'üìÅ '+esc(t.ifile):'‚ñ∂')+'</div>';
  if(t.type==="shoppable_image")return t.img?'<div style="position:relative"><img src="'+t.img+'" style="width:100%;height:auto"><span style="position:absolute;top:4px;right:4px;background:rgba(255,255,255,.9);padding:1px 6px;border-radius:3px;font-size:10px">üõí</span></div>':'<div class="timgph">üõíüñºÔ∏è</div>';
  if(t.type==="gallery")return'<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:3px;padding:6px">'+"1234".split("").map(()=>'<div style="aspect-ratio:1;background:#f3f4f6;border-radius:2px;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:14px">üñºÔ∏è</div>').join("")+'</div>';
  const mob=S.dev==="mobil";
  const hasImg=mob&&t.imgM?t.imgM:t.img;
  if(hasImg)return'<img src="'+hasImg+'" style="width:100%;height:auto;display:block">';
  // Show wireframe if composition data exists or imageBriefing exists
  if(t.ib||t.content?.composition||t.composition){
    const ar=t.content?.w&&t.content?.h?t.content.w/t.content.h:2;
    return mkWireframe(t,300,Math.round(300/ar));
  }
  return'<div class="timgph">'+td.i+'</div>';
}
function rProps(){
  const pg=cp();if(!pg)return'<div class="sr-h"><h3>‚Äî</h3></div>';
  if(S.ss==="h")return'<div class="sr-h"><h3>Header</h3><button class="cb" onclick="S.ss=null;R()">< Fertig</button></div><div class="sr-s"><div class="specs"><b>Min:</b> 3000√ó600px<br><b>Max:</b> 5 MB<br><b>Format:</b> PNG, JPG</div><div class="sf"><div class="sup'+(pg.himg?" ok":"")+'" onclick="upHdr()">'+(pg.himg?"‚úì "+pg.hfile:"Bild hochladen")+'</div></div></div>';
  if(S.ss&&S.sc!==null){const sec=pg.sections.find(x=>x.id===S.ss);
    if(sec&&sec.tiles[S.sc]){const t=sec.tiles[S.sc],td=TT[t.type];
      let h='<div class="sr-h"><h3>'+td.i+' '+td.n+'</h3><button class="cb" onclick="setT(\''+sec.id+'\','+S.sc+',null);S.sc=null;R()">üóë</button></div><div class="sr-s">';
      if(td.sp){h+='<div class="specs">';Object.entries(td.sp).forEach(([k,v])=>{h+='<b>'+k+':</b> '+v+'<br>'});h+='</div>'}
      if(td.img&&td.dual){
        const dw=t.content?.w||3000,dh=t.content?.h||1500;
        h+='<div class="sf"><label>Empfohlene Gr√∂√üe</label><div style="display:flex;gap:4px"><input style="width:50%" value="'+dw+'" oninput="uTC(\'w\',parseInt(this.value)||3000)" placeholder="Breite"><input style="width:50%" value="'+dh+'" oninput="uTC(\'h\',parseInt(this.value)||1500)" placeholder="H√∂he"></div><div class="ht">Desktop: min 3000 breit | Mobil: min 1680 breit</div></div>';
        h+='<div class="sf"><label>üñ• Desktop-Bild</label><div class="sup'+(t.img?" ok":"")+'" onclick="upImg(\''+sec.id+'\','+S.sc+',\'desktop\')">'+(t.img?"‚úì "+t.ifile+" ("+t.iw+"√ó"+t.ih+")":"Desktop hochladen")+'</div></div>';
        h+='<div class="sf"><label>üì± Mobil-Bild</label><div class="sup'+(t.imgM?" ok":"")+'" onclick="upImg(\''+sec.id+'\','+S.sc+',\'mobile\')">'+(t.imgM?"‚úì "+t.ifileM+" ("+t.iwM+"√ó"+t.ihM+")":"Mobil hochladen")+'</div></div>';
      } else if(td.img){
        h+='<div class="sf"><label>Bild / Video</label><div class="sup'+(t.img?" ok":"")+'" onclick="upImg(\''+sec.id+'\','+S.sc+',\'desktop\')">'+(t.img?"‚úì "+t.ifile+" ("+t.iw+"√ó"+t.ih+")":t.ifile||"Hochladen")+'</div></div>';
      }
      if(td.img)h+='<div class="sf"><label>üé® Designer Briefing (EN)</label><textarea oninput="uTP(\'ib\',this.value)">'+esc(t.ib||"")+'</textarea></div>';
      if(t.type==="text"){h+='<div class="sf"><label>Titel</label><input value="'+esc(t.content.title||"")+'" oninput="uTC(\'title\',this.value)"></div>';
        h+='<div class="sf"><label>Text</label><textarea oninput="uTC(\'text\',this.value)">'+esc(t.content.text||"")+'</textarea><div class="ht">Max 2-3 kurze S√§tze</div></div>'}
      if(t.type==="image_text"){h+='<div class="sf"><label>Headline</label><input value="'+esc(t.content.headline||"")+'" oninput="uTC(\'headline\',this.value)"></div>';
        h+='<div class="sf"><label>Body</label><textarea oninput="uTC(\'body\',this.value)">'+esc(t.content.body||"")+'</textarea></div>';
        h+='<div class="sf"><label>Link-Text</label><input value="'+esc(t.content.linkText||"")+'" oninput="uTC(\'linkText\',this.value)"></div>'}
      if(t.type==="product")h+='<div class="sf"><label>ASIN</label><input value="'+esc(t.content.asin||"")+'" oninput="uTC(\'asin\',this.value)" placeholder="B0XXXXXXXXX"></div>';
      if(["product_grid","product_collection"].includes(t.type))h+='<div class="sf"><label>ASINs (je Zeile)</label><textarea oninput="uTC(\'asins\',this.value)">'+esc(t.content.asins||"")+'</textarea></div>';
      if(t.type==="shoppable_image")h+='<div class="sf"><label>Produkt-ASINs (je Zeile)</label><textarea oninput="uTC(\'products\',this.value)">'+esc((t.content.products||[]).join("\\n"))+'</textarea></div>';
      if(t.type==="product_selection"){
        h+='<div class="sf"><label>Intro-Titel</label><input value="'+esc(t.content.introTitle||"")+'" oninput="uTC(\'introTitle\',this.value)"></div>';
        h+='<div class="sf"><label>Intro-Text</label><textarea oninput="uTC(\'introText\',this.value)">'+esc(t.content.introText||"")+'</textarea></div>';
        h+='<div class="sf"><label>Ergebnis-Titel</label><input value="'+esc(t.content.resultsTitle||"")+'" oninput="uTC(\'resultsTitle\',this.value)"></div>';
        const qs=t.content.questions||[];
        h+='<div class="sf"><label>Fragen ('+qs.length+')</label>';
        qs.forEach((q,qi)=>{
          h+='<div style="padding:6px;border:1px solid #eee;border-radius:3px;margin-bottom:4px;font-size:10px">';
          h+='<div style="font-weight:700;margin-bottom:2px">Frage '+(qi+1)+': '+esc(q.q||"")+'</div>';
          (q.answers||[]).forEach((a,ai)=>{
            h+='<div style="padding:2px 0;color:#555">‚Üí '+esc(a.a||"")+(a.products?.length?' <span style="color:#888">['+a.products.join(",")+']</span>':'')+'</div>'});
          h+='</div>'});
        h+='<div class="ht">Quiz-Daten bearbeiten: JSON direkt im Feld unten</div>';
        h+='<textarea style="font-family:monospace;font-size:10px;min-height:100px" oninput="try{uTC(\'questions\',JSON.parse(this.value))}catch(e){}">'+esc(JSON.stringify(qs,null,1))+'</textarea></div>'
      }
      if(t.type==="gallery"){h+='<div class="sf"><label>Bilderbeschreibungen</label><textarea oninput="uTC(\'images\',this.value.split(\'\\n\'))">'+esc((t.content.images||[]).join("\\n"))+'</textarea><div class="ht">Eine Beschreibung pro Zeile (3-8)</div></div>'}
      return h+'</div>'}}
  if(S.ss){const sec=pg.sections.find(x=>x.id===S.ss);
    if(sec){const l=LY.find(x=>x.id===sec.lid)||LY[0];
      let h='<div class="sr-h"><h3>'+l.n+'</h3></div><div class="sr-s"><div class="sf"><label>'+l.cells+' Kacheln</label>';
      sec.tiles.forEach((t,ci)=>{h+='<div style="padding:6px;border:1px solid #eee;border-radius:3px;margin-bottom:4px;font-size:11px;display:flex;justify-content:space-between">';
        if(t){h+='<span>'+TT[t.type].i+' '+TT[t.type].n+'</span><button style="color:var(--red);font-size:10px" onclick="setT(\''+sec.id+'\','+ci+',null)">‚úï</button>'}
        else h+='<span style="color:#bbb">‚Äî</span><button style="color:var(--blue);font-size:10px" onclick="S.stp={s:\''+sec.id+'\',c:'+ci+'};R()">+</button>';
        h+='</div>'});
      h+='</div><div class="sf"><label>Aktionen</label>';
      h+='<button class="asb" onclick="mvSec(\''+sec.id+'\',-1)">‚Üë Nach oben</button>';
      h+='<button class="asb" onclick="mvSec(\''+sec.id+'\',1)">‚Üì Nach unten</button>';
      h+='<button class="asb" style="color:var(--red);border-color:#fecaca" onclick="delSec(\''+sec.id+'\')">üóë L√∂schen</button>';
      return h+'</div></div>'}}
  let h='<div class="sr-h"><h3>'+esc(pg.name)+'</h3></div><div class="sr-s"><button class="asb" onclick="S.slp=true;R()">+ Abschnitt</button>';
  pg.sections.forEach((s,i)=>{const l=LY.find(x=>x.id===s.lid)||LY[0];
    h+='<div style="padding:6px;border:1px solid #eee;border-radius:3px;margin-bottom:3px;font-size:11px;cursor:pointer;display:flex;justify-content:space-between" onclick="S.ss=\''+s.id+'\';R()"><span>'+(i+1)+'. '+l.n+'</span><span style="color:#999">'+s.tiles.filter(Boolean).length+'/'+l.cells+'</span></div>'});
  return h+'</div>';
}
function rLP(){let h='<div class="mbg" onclick="S.slp=null;R()"><div class="mbox" style="max-width:380px;max-height:80vh;overflow-y:auto" onclick="event.stopPropagation()"><div style="padding:12px;font-weight:800;border-bottom:1px solid #eee">Layout ausw√§hlen</div>';
  ["Variable","Basis"].forEach(cat=>{
    h+='<div style="padding:8px 12px 4px;font-size:11px;font-weight:700;color:#888;text-transform:uppercase">'+cat+' H√∂he</div><div class="lpg">';
    LY.filter(l=>l.cat===cat).forEach(l=>{h+='<div class="lpo" style="grid-template-columns:'+l.c+'" onclick="addSec(\''+l.id+'\');S.slp=null;R()">';for(let i=0;i<Math.min(l.cells,6);i++)h+='<div class="c"></div>';h+='</div>'});
    h+='</div>'});
  return h+'</div></div>'}
function rTP(){const p=S.stp;let h='<div class="mbg" onclick="S.stp=null;R()"><div class="mbox" style="max-width:340px;max-height:70vh;overflow-y:auto" onclick="event.stopPropagation()"><div style="padding:12px;font-weight:800;border-bottom:1px solid #eee">Kacheltyp</div>';
  TG.forEach(g=>{Object.entries(TT).filter(([,v])=>v.g===g).forEach(([k,v])=>{
    h+='<div class="tpi" onclick="setT(\''+p.s+'\','+p.c+',mkT(\''+k+'\'));S.stp=null;R()"><div class="ic">'+v.i+'</div><div><h5>'+v.n+(v.nw?' <span style="background:#e8daef;color:#6c3483;font-size:8px;padding:0 3px;border-radius:2px">Neu</span>':'')+'</h5><p>'+v.d+'</p></div></div>'})});
  return h+'</div></div>'}
function rGM(){return'<div class="mbg" onclick="S.sgm=false;R()"><div class="mbox" onclick="event.stopPropagation()"><div style="padding:14px;border-bottom:1px solid #eee"><h3 style="font-size:15px;font-weight:800">‚ú® AI Store Generator</h3></div><div style="padding:14px;display:flex;flex-direction:column;gap:8px"><div class="sf"><label>Markenname *</label><input id="gb" placeholder="z.B. K√§rcher, HOLY..."></div><div class="sf"><label>Marktplatz</label><select id="gm"><option value="de">üá©üá™ de</option><option value="com">üá∫üá∏ com</option><option value="co.uk">üá¨üáß uk</option><option value="fr">üá´üá∑ fr</option></select></div><div class="sf"><label>Kategorie</label><input id="gc"></div><div class="sf"><label>Info</label><textarea id="gi" rows="2"></textarea></div></div><div style="padding:14px;display:flex;justify-content:flex-end;gap:6px"><button class="tb" onclick="S.sgm=false;R()">Abbrechen</button><button class="tb p" onclick="S.sgm=false;generate(document.getElementById(\'gb\').value,document.getElementById(\'gm\').value,document.getElementById(\'gc\').value,document.getElementById(\'gi\').value)">üöÄ Los</button></div></div></div>'}
function rGO(){let h='<div class="gbg"><div class="gbox"><div style="padding:14px"><div style="font-weight:700;margin-bottom:6px">Generiere...</div>';
  S.gss.forEach((s,i)=>{const c=i<S.gs?"done":i===S.gs?"act":"pen";h+='<div class="gst '+c+'">'+(i<S.gs?"‚úÖ":i===S.gs?"‚è≥":"‚¨ú")+' <b>'+s.n+'</b> <span style="opacity:.6">'+s.d+'</span></div>'});
  h+='</div><div class="glog">';S.gl.forEach(l=>{h+='<div'+(l.includes("‚ùå")?' class="e"':"")+'>'+esc(l)+'</div>'});
  return h+'<div style="color:#4ade80">_</div></div></div></div>'}
function rEP(){let h='<div class="mbg" onclick="S.se=false;R()"><div class="mbox" style="max-width:600px;max-height:70vh;display:flex;flex-direction:column" onclick="event.stopPropagation()"><div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between"><h3 style="color:var(--red)">üêõ Errors ('+S.el.length+')</h3><div><button class="tb" onclick="S.el=[];S.se=false;R()">Clear</button> <button class="tb" onclick="S.se=false;R()">‚úï</button></div></div><div style="flex:1;overflow-y:auto;padding:10px">';
  S.el.forEach(e=>{h+='<div class="ei"><div class="t">'+e.t+'</div><div class="mg">'+esc(e.m)+'</div>'+(e.d?'<pre>'+esc(e.d)+'</pre>':'')+'</div>'});
  return h+'</div></div></div>'}
function rBF(){return'<div class="bfg" onclick="S.sbf=null;R()"><div class="bfbox" onclick="event.stopPropagation()"><div style="padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><h3 style="font-size:15px;font-weight:700">üìã Designer Briefing (editable)</h3><div style="display:flex;gap:6px"><button class="tb p" onclick="exportBriefing()">üì• Export .md</button><button class="tb" onclick="S.sbf=null;R()">‚úï</button></div></div><textarea id="bf-ta" style="flex:1;border:none;padding:14px;font-family:monospace;font-size:12px;line-height:1.6;resize:none;min-height:400px">'+esc(S.sbf)+'</textarea></div></div>'}

R();if(!apiKey)setTimeout(pKey,300);
</script>
</body>
</html>
