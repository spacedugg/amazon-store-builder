<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amazon Brand Store Builder â€” Multi-Step AI</title>
<style>
:root { --orange:#FF9900; --dark:#1a1a2e; --blue:#007EB9; --green:#059669; --red:#dc2626; --gray:#6b7280; --border:#e2e4e8; --bg:#f0f1f3; }
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--dark);-webkit-font-smoothing:antialiased}
button{cursor:pointer;border:none;background:none;font-family:inherit}
input,textarea,select{font-family:inherit;outline:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}

#app{display:flex;flex-direction:column;height:100vh}

/* Header */
header{display:flex;align-items:center;height:52px;padding:0 16px;gap:12px;background:var(--dark);flex-shrink:0}
.logo{display:flex;align-items:center;gap:8px;color:#fff;font-weight:700;font-size:14px}
.badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:800;background:var(--orange);color:var(--dark)}
.brand-info{display:flex;align-items:center;gap:8px;margin-left:12px;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,.08)}
.brand-dot{width:12px;height:12px;border-radius:50%}
.brand-text{font-size:12px;color:#9ca3af}
.modes{flex:1;display:flex;justify-content:center;gap:4px}
.mode-btn{padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;color:#6b7280}
.mode-btn.active{color:#fff;background:rgba(255,255,255,.12)}
.actions{display:flex;gap:6px}
.btn{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;background:var(--orange);color:var(--dark)}
.btn-out{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:600;color:#9ca3af;border:1px solid #4b5563}
.btn-out:hover{color:#fff}
.btn-err{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:600;color:var(--red);border:1px solid var(--red)}

/* Main */
.main{display:flex;flex:1;overflow:hidden}

/* Sidebar */
.sidebar{width:220px;background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-title{padding:10px;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px}
.grp-label{font-size:9px;font-weight:700;color:#9ca3af;text-transform:uppercase;padding:0 8px;margin:8px 0 2px;letter-spacing:.5px}
.tile-btn{width:100%;display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:6px;text-align:left;font-size:12px}
.tile-btn:hover{background:#f5f5f5}
.tile-btn .icon{font-size:14px;flex-shrink:0}
.tile-btn .name{font-weight:500;color:#374151}

/* Canvas */
.canvas-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
.page-tabs{display:flex;align-items:center;gap:4px;padding:6px 12px;background:#fff;border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0}
.ptab{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;border:1px solid #e5e7eb;color:#6b7280;display:flex;align-items:center;gap:4px}
.ptab.active{background:var(--dark);border-color:var(--dark);color:#fff}
.ptab .del{opacity:.4;margin-left:4px;font-size:10px;cursor:pointer}.ptab .del:hover{opacity:1}
.add-page{padding:4px 8px;border:1px dashed #d1d5db;border-radius:6px;font-size:12px;color:#9ca3af}
.canvas{flex:1;overflow-y:auto;padding:16px}
.canvas-inner{max-width:900px;margin:0 auto}

/* Hero */
.hero{margin-bottom:12px;border-radius:12px;border:2px dashed #d1d5db;min-height:100px;background:linear-gradient(135deg,var(--dark),#2d2d5e);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;color:rgba(255,255,255,.4);text-align:center}
.hero .emoji{font-size:20px;margin-bottom:4px}.hero .spec{font-size:12px;font-weight:600}.hero .brief{font-size:11px;margin-top:4px;color:rgba(255,255,255,.25);font-style:italic}

/* Tile card */
.tile-card{background:#fff;border-radius:12px;overflow:hidden;margin-bottom:10px;cursor:pointer;position:relative;border:2px solid transparent;box-shadow:0 1px 3px rgba(0,0,0,.04);transition:all .15s}
.tile-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.tile-card.selected{box-shadow:0 4px 16px rgba(0,0,0,.1)}
.tile-badge{position:absolute;top:6px;left:6px;z-index:10;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;background:var(--dark);color:#fff}
.tile-toolbar{position:absolute;top:6px;right:6px;z-index:10;display:none;gap:3px}
.tile-card:hover .tile-toolbar,.tile-card.selected .tile-toolbar{display:flex}
.tb-btn{width:22px;height:22px;border-radius:4px;background:rgba(255,255,255,.9);box-shadow:0 1px 4px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;font-size:10px}
.tb-btn:hover{background:var(--dark);color:#fff}
.briefing-badge{position:absolute;bottom:6px;right:6px;z-index:10;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;background:#fef3c7;color:#92400e}
.img-badge{position:absolute;bottom:6px;left:6px;z-index:10;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;background:#dcfce7;color:#166534}

/* Tile placeholders */
.tile-ph{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;background:#f3f4f6;color:#9ca3af;min-height:140}
.tile-ph .emoji{font-size:30px;margin-bottom:8px}.tile-ph .label{font-size:12px;font-weight:600}.tile-ph .brief{font-size:11px;margin-top:4px;font-style:italic;max-width:400px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tile-product{padding:20px;text-align:center}.tile-auto{padding:20px;text-align:center}
.tile-text{padding:20px}

/* Properties */
.props{width:280px;background:#fff;border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.props-title{padding:10px;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:#9ca3af;text-transform:uppercase}
.props-scroll{flex:1;overflow-y:auto;padding:10px}
.spec-box{background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;padding:10px;margin-bottom:12px;font-size:12px;color:#92400e}
.spec-box b{display:inline}
.field{margin-bottom:12px}
.field label{display:block;margin-bottom:3px;font-size:10px;font-weight:600;color:#9ca3af;text-transform:uppercase;letter-spacing:.3px}
.field input,.field select,.field textarea{width:100%;padding:6px 10px;border-radius:8px;font-size:12px;border:1px solid #ddd}
.field textarea{resize:vertical;min-height:60px}

/* Briefing panel */
.briefing-panel{width:320px;background:#fff;border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.bp-scroll{flex:1;overflow-y:auto;padding:10px}
.bp-brand{background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px}
.bp-hero{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px;margin-bottom:8px}
.bp-tile{border-radius:8px;padding:10px;margin-bottom:6px;border:1px solid #fcd34d;background:#fffbeb}
.bp-tile.no-img{border-color:#e5e7eb;background:#f9fafb}

/* Refine bar */
.refine-bar{display:flex;gap:8px;padding:10px;background:#fff;border-top:1px solid var(--border);flex-shrink:0}
.refine-bar input{flex:1;padding:6px 10px;border-radius:8px;font-size:12px;border:1px solid #ddd}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50;backdrop-filter:blur(4px)}
.modal{background:#fff;border-radius:16px;max-width:420px;width:92%;box-shadow:0 25px 50px rgba(0,0,0,.25)}
.modal h2{font-size:18px;font-weight:800}
.modal p{font-size:12px;color:#9ca3af;margin-top:2px}

/* Generation overlay */
.gen-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:50}
.gen-box{background:#fff;border-radius:16px;max-width:600px;width:92%;box-shadow:0 25px 50px rgba(0,0,0,.3);overflow:hidden;max-height:80vh;display:flex;flex-direction:column}
.gen-step{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;margin-bottom:6px;font-size:12px}
.gen-step.done{background:#ecfdf5;color:#166534}.gen-step.active{background:#fffbeb;color:#92400e;font-weight:600}.gen-step.pending{background:#f9fafb;color:#9ca3af}
.gen-log{background:#111827;padding:16px;overflow-y:auto;flex:1;font-family:'Menlo','Consolas',monospace}
.gen-log div{font-size:11px;color:#4ade80;line-height:1.7;word-break:break-all}
.gen-log div.err{color:#f87171}

/* Error panel */
.err-panel{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
.err-box{background:#fff;border-radius:16px;max-width:700px;width:92%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,.3)}
.err-item{margin-bottom:12px;padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px}
.err-item .time{font-size:11px;color:#9ca3af;margin-bottom:4px}
.err-item .msg{font-size:13px;font-weight:600;color:var(--red);margin-bottom:4px;word-break:break-all}
.err-item pre{font-size:10px;color:var(--gray);background:#fff;padding:8px;border-radius:4px;border:1px solid #e5e7eb;overflow:auto;max-height:200px;white-space:pre-wrap;word-break:break-all}

/* Toast */
.toast{position:fixed;top:16px;right:16px;z-index:60;padding:10px 16px;border-radius:12px;font-size:12px;font-weight:600;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.toast.ok{background:var(--green)}.toast.err{background:var(--red)}

/* Empty */
.empty{border:2px dashed #d1d5db;border-radius:16px;padding:40px;text-align:center;color:#9ca3af;background:#fff}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AMAZON BRAND STORE BUILDER â€” Single HTML, Direct API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TILES = {
  hero_image:{name:"Hero Image",icon:"ğŸ–¼ï¸",grp:"Header",sizes:["full_width"],needsImage:true,specs:{full_width:{min:"3000Ã—600px",rec:"3000Ã—1200px",max:"5MB",safe:"Mittlere 70%",fmt:"JPG/PNG"}}},
  image:{name:"Image",icon:"ğŸ–¼ï¸",grp:"Content",sizes:["full_width","large","medium","small"],needsImage:true,specs:{full_width:{min:"1500Ã—20px",rec:"3000px Breite",max:"5MB"},large:{min:"1500Ã—1500px"},medium:{min:"1500Ã—750px"},small:{min:"750Ã—750px"}}},
  image_with_text:{name:"Image + Text",icon:"ğŸ“",grp:"Content",sizes:["full_width","large","medium","small"],needsImage:true,specs:{full_width:{min:"3000Ã—1500px",max:"5MB"},large:{min:"1500Ã—1500px"},medium:{min:"1500Ã—750px"},small:{min:"750Ã—750px"}}},
  shoppable_image:{name:"Shoppable Image",icon:"ğŸ›’",grp:"Content",sizes:["full_width","large","medium","small"],needsImage:true,specs:{full_width:{min:"1500Ã—750px",rec:"3000Ã—1500px",max:"5MB",note:"Bis zu 6 Hotspots"}}},
  text:{name:"Text",icon:"ğŸ“",grp:"Content",sizes:["full_width","large","medium","small"],needsImage:false},
  video:{name:"Video",icon:"ğŸ¥",grp:"Media",sizes:["full_width","large","medium"],needsImage:true,specs:{full_width:{cover:"3000Ã—1500px",video:"1280Ã—640px",fmt:"MP4 H.264"}}},
  background_video:{name:"BG Video",icon:"ğŸ¬",grp:"Media",sizes:["full_width","large","medium"],needsImage:false,specs:{full_width:{video:"1280Ã—640px",dur:"2â€“20s",note:"Max 4/Seite"}}},
  gallery:{name:"Gallery",icon:"ğŸ¨",grp:"Content",sizes:["full_width"],needsImage:true,specs:{full_width:{min:"1500Ã—750px",count:"3â€“8 Bilder"}}},
  product:{name:"Product",icon:"ğŸ“¦",grp:"Produkte",sizes:["full_width","large","medium","small"],needsImage:false},
  product_grid:{name:"Product Grid",icon:"ğŸ›ï¸",grp:"Produkte",sizes:["full_width"],needsImage:false,specs:{full_width:{note:"Max 1/Seite"}}},
  best_sellers:{name:"Best Sellers",icon:"ğŸ†",grp:"Produkte",sizes:["full_width"],needsImage:false},
  recommended:{name:"Recommended",icon:"ğŸ’¡",grp:"Produkte",sizes:["full_width"],needsImage:false},
  featured_deals:{name:"Featured Deals",icon:"ğŸ·ï¸",grp:"Produkte",sizes:["full_width"],needsImage:false},
};
const SIZE_LABELS = {full_width:"Full Width",large:"Large",medium:"Medium",small:"Small"};
const GROUPS = ["Header","Content","Media","Produkte"];
const LANG = {de:"German",com:"English","co.uk":"English",fr:"French",it:"Italian",es:"Spanish"};

const uid = ()=>`${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
const mkTile = (type,size="full_width",content={},briefing="")=>({id:uid(),type,size:TILES[type]?.sizes.includes(size)?size:(TILES[type]?.sizes[0]||"full_width"),content,imageBriefing:briefing,image:null,imageFile:"",imgW:0,imgH:0});
const mkPage = (name,id)=>({id:id||uid(),name,heroImageBriefing:"",tiles:[]});

// â”€â”€ State â”€â”€
let state = {
  store:{brandName:"",brandProfile:null,pages:[mkPage("Homepage","homepage")]},
  curPage:"homepage", selTile:null, mode:"builder",
  generating:false, genStep:0, genSteps:[], genLog:[],
  errorLog:[], showErrors:false, toast:null,
};
let apiKey = localStorage.getItem("asb_api_key")||"";

// â”€â”€ Prompts â”€â”€
const PROMPTS = {
  research:`You research brands for Amazon Brand Store creation. Use web search to find:
1. Brand website, mission, values, visual identity (colors, style)
2. Product categories and range
3. Amazon presence: product names, ASINs (B0XXXXXXXXX format), categories
Do NOT collect prices. Return ONLY valid JSON:
{"brandName":"...","description":"1-2 sentences","type":"premium|d2c|mission|mass_market","tone":"...","colors":{"primary":"#hex","secondary":"#hex","accent":"#hex"},"categories":["Cat1"],"usps":["USP1","USP2","USP3"],"targetAudience":"...","products":[{"name":"...","asin":"B0XX","category":"Cat"}],"amazonCategories":["..."],"hasExistingStore":false}`,
  architecture:`You plan Amazon Brand Store page structures. Homepage first, then 1 page per major category. Premium: About page. D2C: Bestseller/Bundles. Mission: Impact page. Mass Market: Deals + categories. 4-12 pages. Tile types: hero_image, image, image_with_text, shoppable_image, text, video, background_video, gallery, product, product_grid, best_sellers, recommended, featured_deals
Return ONLY valid JSON:
{"pages":[{"id":"homepage","name":"Homepage","purpose":"...","tileSequence":["hero_image: keyvisual","image x3 medium: categories"]}]}`,
  content:`You create content for ONE Amazon Brand Store page with designer image briefings. ONLY real tile types: hero_image, image, image_with_text, shoppable_image, text, video, background_video, gallery, product, product_grid, best_sellers, recommended, featured_deals. Max 20 tiles, max 1 product_grid, max 1 gallery. Every image tile MUST have imageBriefing: DIMENSIONS (px) | CONTENT | TEXT IN IMAGE | COLORS (hex) | MOOD | MOBILE. All text in marketplace language, no placeholders.
Return ONLY valid JSON:
{"pageName":"...","heroImageBriefing":"...","tiles":[{"type":"image_with_text","size":"full_width","content":{"headline":"...","body":"..."},"imageBriefing":"DIMENSIONS: 3000x1500px | CONTENT: ... | TEXT: ... | COLORS: ... | MOOD: ..."}]}`,
  refine:`Refine an Amazon Brand Store. ONLY real tile types. Keep imageBriefings. Return COMPLETE store JSON with all pages.`
};

// â”€â”€ API â”€â”€
async function callAI(system, user, useSearch=false) {
  if(!apiKey) throw new Error("API Key fehlt!");
  const body = {model:"claude-sonnet-4-20250514",max_tokens:6000,system,messages:[{role:"user",content:user}]};
  if(useSearch) body.tools=[{type:"web_search_20250305",name:"web_search"}];
  for(let a=0;a<3;a++){
    let r;
    try{
      r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(body)});
    }catch(e){throw new Error("Network: "+e.message)}
    if(r.status===429&&a<2){addLog("â³ Rate limit, warte "+(15*(a+1))+"s...");await new Promise(x=>setTimeout(x,15000*(a+1)));continue}
    if(!r.ok){const t=await r.text();addErr("API "+r.status,t);throw new Error("API "+r.status+": "+t.slice(0,200))}
    const d=await r.json();
    const txt=(d.content||[]).filter(b=>b.type==="text").map(b=>b.text).join("");
    const m=txt.match(/\{[\s\S]*\}/);
    if(!m){addErr("No JSON",txt.slice(0,500));throw new Error("No JSON in response")}
    return JSON.parse(m[0]);
  }
  throw new Error("Rate limit nach Retries");
}

function addLog(msg){state.genLog.push("["+new Date().toLocaleTimeString()+"] "+msg);render()}
function addErr(msg,detail){state.errorLog.push({time:new Date().toLocaleTimeString(),msg,detail:detail||""});render()}
function toast(m,t){state.toast={m,t:t||"ok"};render();setTimeout(()=>{state.toast=null;render()},4000)}

// â”€â”€ Getters â”€â”€
function curPage(){return state.store.pages.find(p=>p.id===state.curPage)||state.store.pages[0]}
function curTile(){const p=curPage();return p?p.tiles.find(t=>t.id===state.selTile):null}

// â”€â”€ Generation â”€â”€
async function generate(brand,mp,cat,info){
  if(!apiKey){promptKey();return}
  state.generating=true;state.genLog=[];
  const lang=LANG[mp]||"German";
  state.genSteps=[{name:"Recherche",desc:"Marke & Amazon..."},{name:"Architektur",desc:"Seiten & Tiles..."},{name:"Content",desc:"Texte & Briefings..."},{name:"Validierung",desc:"PrÃ¼fen..."}];
  state.genStep=0;render();
  try{
    addLog("ğŸ” Recherchiere "+brand+"...");
    const bp=await callAI(PROMPTS.research,`Research "${brand}" for Amazon.${mp}. ${cat?`Category: ${cat}.`:""} ${info||""} JSON in English, brand content in ${lang}.`,true);
    addLog("âœ… "+bp.type+", "+(bp.categories?.length||0)+" Kategorien, "+(bp.products?.length||0)+" Produkte");
    state.genStep=1;render();

    addLog("ğŸ—ï¸ Architektur...");
    const arch=await callAI(PROMPTS.architecture,`Brand: ${JSON.stringify(bp)}\nCategories: ${(bp.amazonCategories||bp.categories||[]).join(", ")}\nProducts: ${bp.products?.length||0}\nLanguage: ${lang}`);
    addLog("âœ… "+(arch.pages?.length||0)+" Seiten");
    (arch.pages||[]).forEach(p=>addLog("   ğŸ“„ "+p.name));
    state.genStep=2;render();

    const prods=(bp.products||[]).slice(0,15).map(p=>`${p.name} (${p.asin})`).join(", ");
    const pages=[];
    for(let i=0;i<(arch.pages||[]).length;i++){
      const pp=arch.pages[i];
      addLog("ğŸ“ "+(i+1)+"/"+(arch.pages.length)+": "+pp.name+"...");render();
      const pc=await callAI(PROMPTS.content,`PAGE: ${JSON.stringify(pp)}\nBRAND: type=${bp.type}, tone=${bp.tone}, colors=${JSON.stringify(bp.colors)}, USPs=${(bp.usps||[]).join(", ")}\nPRODUCTS: ${prods}\nLanguage: ${lang}`);
      const tiles=(pc.tiles||[]).filter(t=>TILES[t.type]).map(t=>mkTile(t.type,t.size,t.content||{},t.imageBriefing||""));
      pages.push({id:pp.id||"page_"+i,name:pc.pageName||pp.name,heroImageBriefing:pc.heroImageBriefing||"",tiles});
      addLog("   âœ… "+tiles.length+" Tiles");
    }

    state.genStep=3;addLog("ğŸ” Validiere...");render();
    let w=0;
    pages.forEach(p=>{
      ["product_grid","gallery","featured_deals","recommended"].forEach(type=>{let f=false;p.tiles=p.tiles.filter(t=>{if(t.type===type){if(f)return false;f=true}return true})});
      if(p.tiles.length>20){p.tiles=p.tiles.slice(0,20);w++}
    });
    addLog("âœ… "+w+" Warnungen");

    state.store={brandName:brand,brandProfile:bp,pages};
    state.curPage=pages[0]?.id;state.selTile=null;
    const tot=pages.reduce((a,p)=>a+p.tiles.length,0);
    addLog("\nğŸ‰ FERTIG: "+pages.length+" Seiten, "+tot+" Tiles");
    toast(pages.length+" Seiten, "+tot+" Tiles");
  }catch(e){
    addLog("âŒ "+e.message);addErr("Generation: "+e.message,e.stack);toast(e.message,"err");
  }finally{state.generating=false;render()}
}

async function doRefine(instruction){
  if(!apiKey){promptKey();return}
  if(!instruction.trim())return;
  state.generating=true;state.genSteps=[{name:"Verfeinere...",desc:instruction}];state.genStep=0;state.genLog=[];render();
  addLog('âœï¸ "'+instruction+'"');
  const clean=JSON.parse(JSON.stringify(state.store));
  clean.pages.forEach(p=>p.tiles.forEach(t=>{t.image=null}));
  try{
    const r=await callAI(PROMPTS.refine,`STORE:\n${JSON.stringify(clean)}\n\nCHANGE: ${instruction}\n\nReturn complete JSON.`);
    if(r.pages?.length){
      state.store.pages=r.pages.map((p,i)=>({...mkPage(p.name,p.id||"page_"+i),heroImageBriefing:p.heroImageBriefing||"",tiles:(p.tiles||[]).filter(t=>TILES[t.type]).map(t=>mkTile(t.type,t.size,t.content||{},t.imageBriefing||""))}));
      if(r.brandProfile)state.store.brandProfile=r.brandProfile;
      state.curPage=state.store.pages[0]?.id;
      addLog("âœ… Verfeinert");toast("Store verfeinert!");
    }
  }catch(e){addLog("âŒ "+e.message);addErr(e.message);toast(e.message,"err")}
  finally{state.generating=false;render()}
}

// â”€â”€ Exports â”€â”€
function exportBriefing(){
  const s=state.store,bp=s.brandProfile;
  let md="# Designer Briefing: "+s.brandName+"\n\n";
  if(bp)md+="## Brand\n- Typ: "+bp.type+"\n- Ton: "+bp.tone+"\n- Farben: "+(bp.colors?Object.values(bp.colors).join(", "):"")+"\n- USPs: "+(bp.usps||[]).join(" | ")+"\n\n---\n\n";
  s.pages.forEach((pg,pi)=>{
    md+="# Seite "+(pi+1)+": "+pg.name+"\n\n## Hero\n- 3000Ã—600px, max 5MB, Safe Zone 70%\n- "+(pg.heroImageBriefing||"â€”")+"\n\n";
    pg.tiles.forEach((t,ti)=>{
      const d=TILES[t.type];md+="### "+(ti+1)+". "+(d?.name||t.type)+" ("+SIZE_LABELS[t.size]+")\n";
      if(t.imageBriefing)md+="ğŸ¨ "+t.imageBriefing+"\n";
      if(t.image)md+="âœ… "+t.imageFile+" ("+t.imgW+"Ã—"+t.imgH+")\n";
      else if(d?.needsImage)md+="âš  Bild fehlt\n";
      md+="\n";
    });md+="---\n\n";
  });
  dl(md,s.brandName+"_briefing.md","text/markdown");
}
function exportJSON(){
  const d=JSON.parse(JSON.stringify(state.store));d.pages.forEach(p=>p.tiles.forEach(t=>{t.image=null}));
  dl(JSON.stringify(d,null,2),state.store.brandName+"_store.json","application/json");
}
function dl(content,name,type){const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click()}

// â”€â”€ Key prompt â”€â”€
function promptKey(){
  const k=prompt("Anthropic API Key eingeben (sk-ant-...):",apiKey);
  if(k){apiKey=k;localStorage.setItem("asb_api_key",k);toast("Key gespeichert")}
}

// â”€â”€ Image upload â”€â”€
function uploadImg(tileId){
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*";
  inp.onchange=()=>{
    const f=inp.files[0];if(!f)return;
    const r=new FileReader();r.onload=e=>{
      const img=new Image();img.onload=()=>{
        const p=curPage();const t=p.tiles.find(x=>x.id===tileId);if(!t)return;
        t.image=e.target.result;t.imageFile=f.name;t.imgW=img.width;t.imgH=img.height;
        toast(img.width+"Ã—"+img.height+"px");render();
      };img.src=e.target.result;
    };r.readAsDataURL(f);
  };inp.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const s=state, st=s.store, pg=curPage(), tl=curTile(), td=tl?TILES[tl.type]:null;
  const bp=st.brandProfile, accent=bp?.colors?.primary||"#FF9900";
  let h='';

  // Header
  h+='<header><div class="logo"><span>ğŸª</span><span>Store Builder</span><span class="badge">MULTI-STEP AI</span></div>';
  if(bp)h+='<div class="brand-info"><span class="brand-dot" style="background:'+accent+'"></span><span class="brand-text">'+st.brandName+' Â· '+bp.type+'</span></div>';
  h+='<div class="modes">';
  ["builder","preview","briefing"].forEach(m=>{
    const icons={builder:"âœï¸ Builder",preview:"ğŸ‘ï¸ Preview",briefing:"ğŸ“‹ Briefing"};
    h+='<button class="mode-btn'+(s.mode===m?" active":"")+'" onclick="state.mode=\''+m+'\';state.selTile=null;render()">'+icons[m]+'</button>';
  });
  h+='</div><div class="actions">';
  h+='<button class="btn" onclick="showGenModal()">âœ¨ AI Generieren</button>';
  if(s.errorLog.length)h+='<button class="btn-err" onclick="state.showErrors=true;render()">ğŸ› '+s.errorLog.length+'</button>';
  h+='<button class="btn-out" onclick="exportBriefing()">ğŸ“‹</button>';
  h+='<button class="btn-out" onclick="exportJSON()">ğŸ“¥</button>';
  h+='<button class="btn-out" onclick="promptKey()">ğŸ”‘</button>';
  h+='</div></header>';

  // Main
  h+='<div class="main">';

  // Sidebar
  if(s.mode==="builder"){
    h+='<div class="sidebar"><div class="sidebar-title">Amazon Tiles</div><div class="sidebar-scroll">';
    GROUPS.forEach(g=>{
      h+='<div class="grp-label">'+g+'</div>';
      Object.entries(TILES).filter(([,v])=>v.grp===g).forEach(([k,v])=>{
        h+='<button class="tile-btn" onclick="addTile(\''+k+'\')"><span class="icon">'+v.icon+'</span><span class="name">'+v.name+'</span></button>';
      });
    });
    h+='</div></div>';
  }

  // Canvas
  h+='<div class="canvas-wrap">';
  // Page tabs
  h+='<div class="page-tabs">';
  st.pages.forEach(p=>{
    h+='<button class="ptab'+(p.id===s.curPage?" active":"")+'" onclick="state.curPage=\''+p.id+'\';state.selTile=null;render()">'+esc(p.name);
    if(st.pages.length>1)h+='<span class="del" onclick="event.stopPropagation();delPage(\''+p.id+'\')">âœ•</span>';
    h+='</button>';
  });
  h+='<button class="add-page" onclick="addPage()">+ Seite</button></div>';

  // Canvas area
  h+='<div class="canvas"><div class="canvas-inner">';
  if(pg){
    if(s.mode!=="preview")h+='<div class="hero"><span class="emoji">ğŸ–¼ï¸</span><div class="spec">Hero Image Â· 3000Ã—600px Â· Safe Zone 70%</div>'+(pg.heroImageBriefing?'<div class="brief">"'+esc(pg.heroImageBriefing).slice(0,80)+'..."</div>':'')+'</div>';
    if(pg.tiles.length===0&&s.mode!=="preview")h+='<div class="empty"><div style="font-size:24px;margin-bottom:8px">ğŸ“¦</div><div style="font-weight:600;color:#6b7280">Keine Tiles</div><div style="font-size:12px;margin-top:4px">Links ein Tile klicken oder âœ¨ AI Generieren</div></div>';
    pg.tiles.forEach(t=>{
      const def=TILES[t.type],isSel=s.selTile===t.id,c=t.content||{};
      if(s.mode==="preview"){h+=renderTileInner(t,def,c);return}
      h+='<div class="tile-card'+(isSel?" selected":"")+'" style="border-color:'+(isSel?accent:"transparent")+'" onclick="state.selTile=\''+t.id+'\';render()">';
      h+='<span class="tile-badge">'+def.name+' Â· '+SIZE_LABELS[t.size]+'</span>';
      h+='<div class="tile-toolbar"><button class="tb-btn" onclick="event.stopPropagation();moveTile(\''+t.id+'\',-1)">â†‘</button><button class="tb-btn" onclick="event.stopPropagation();moveTile(\''+t.id+'\',1)">â†“</button><button class="tb-btn" onclick="event.stopPropagation();delTile(\''+t.id+'\')">âœ•</button></div>';
      if(t.imageBriefing&&!t.image)h+='<span class="briefing-badge">ğŸ“‹ Briefing</span>';
      if(t.image)h+='<span class="img-badge">âœ“ '+t.imgW+'Ã—'+t.imgH+'</span>';
      h+=renderTileInner(t,def,c);
      h+='</div>';
    });
  }
  h+='</div></div>';

  // Refine bar
  if(s.mode==="builder")h+='<div class="refine-bar"><input id="refine-input" placeholder="AI: \'FÃ¼ge Bundle-Seite hinzu\', \'Mehr Lifestyle\'..." onkeydown="if(event.key===\'Enter\')doRefineFromInput()"><button class="btn" onclick="doRefineFromInput()">âœ¨ Verfeinern</button></div>';
  h+='</div>'; // canvas-wrap

  // Properties panel
  if(s.mode==="builder"){
    h+='<div class="props"><div class="props-title">Eigenschaften'+(tl?' <span style="color:'+accent+';text-transform:none;font-weight:500">'+tl.type+'</span>':'')+'</div><div class="props-scroll">';
    if(!tl){h+='<div style="text-align:center;color:#9ca3af;padding-top:32px"><div style="font-size:20px;opacity:.3">ğŸ¯</div><div style="font-size:12px">Tile auswÃ¤hlen</div></div>'}
    else{
      h+='<div class="field"><label>Tile-GrÃ¶ÃŸe</label><select onchange="setTileProp(\'size\',this.value)">';
      td.sizes.forEach(sz=>{h+='<option value="'+sz+'"'+(tl.size===sz?' selected':'')+'>'+SIZE_LABELS[sz]+'</option>'});
      h+='</select></div>';
      if(td.needsImage&&td.specs){
        h+='<div class="spec-box"><div style="font-size:10px;font-weight:700;margin-bottom:4px">ğŸ“ Bild-Spezifikationen</div>';
        const sp=td.specs[tl.size]||Object.values(td.specs)[0]||{};
        Object.entries(sp).forEach(([k,v])=>{h+='<div><b>'+k+':</b> '+v+'</div>'});
        h+='</div>';
      }
      if(td.needsImage)h+='<div class="field"><label>Bild hochladen</label><button style="width:100%;padding:8px;border:2px dashed '+(tl.image?"#86efac":"#ddd")+';border-radius:8px;font-size:12px;color:#6b7280" onclick="uploadImg(\''+tl.id+'\')">'+(tl.image?"âœ“ "+tl.imageFile:"ğŸ“ Bild wÃ¤hlen...")+'</button></div>';
      if(td.needsImage)h+='<div class="field"><label>ğŸ¨ Designer-Briefing</label><textarea id="briefing-ta" oninput="setTileProp(\'imageBriefing\',this.value)" placeholder="DIMENSIONS: ... | CONTENT: ... | COLORS: ... | MOOD: ...">'+esc(tl.imageBriefing||"")+'</textarea></div>';
      if(tl.type==="image_with_text"){
        h+=selField("Layout","content.layout",[["text_over","Text Ã¼ber Bild"],["text_beside","Text neben Bild"]],tl.content.layout);
        h+=inpField("Headline","content.headline",tl.content.headline);
        h+=txtField("Body","content.body",tl.content.body);
        h+=inpField("Link-Text","content.linkText",tl.content.linkText);
      }
      if(tl.type==="text"){h+=txtField("Text","content.text",tl.content.text)}
      if(tl.type==="product"){h+=inpField("ASIN","content.asin",tl.content.asin);h+=inpField("Titel","content.customTitle",tl.content.customTitle)}
      if(tl.type==="product_grid"){h+=txtField("ASINs (eine/Zeile)","content.asins",(tl.content.asins||[]).join("\n"))}
    }
    h+='</div></div>';
  }

  // Briefing panel
  if(s.mode==="briefing"){
    h+='<div class="briefing-panel"><div class="props-title">ğŸ“ Bild-Specs & Briefings</div><div class="bp-scroll">';
    if(bp){
      h+='<div class="bp-brand"><div style="font-size:12px;font-weight:700">'+st.brandName+'</div>';
      if(bp.colors)h+='<div style="display:flex;gap:4px;margin:4px 0">'+Object.values(bp.colors).map(c=>'<span style="width:16px;height:16px;border-radius:50%;border:1px solid #ddd;background:'+c+'"></span>').join("")+'</div>';
      h+='<div style="font-size:11px;color:#6b7280">'+bp.type+' Â· '+bp.tone+'</div></div>';
    }
    h+='<div class="bp-hero"><div style="font-size:12px;font-weight:700;color:#1e40af">Hero Image</div><div style="font-size:11px;color:#1d4ed8;margin-top:2px">3000Ã—600px | max 5MB | Safe Zone 70%</div>'+(pg?.heroImageBriefing?'<div style="font-size:11px;color:#2563eb;margin-top:4px;font-style:italic">'+esc(pg.heroImageBriefing)+'</div>':'')+'</div>';
    (pg?.tiles||[]).forEach((t,i)=>{
      const def=TILES[t.type],ni=def?.needsImage;
      h+='<div class="bp-tile'+(ni?'':' no-img')+'"><div style="font-size:12px;font-weight:700;color:'+(ni?"#92400e":"#6b7280")+'">'+(i+1)+'. '+def.name+' ('+SIZE_LABELS[t.size]+')</div>';
      if(ni&&def.specs){const sp=def.specs[t.size]||Object.values(def.specs)[0]||{};Object.entries(sp).forEach(([k,v])=>{h+='<div style="font-size:11px;color:#92400e"><b>'+k+':</b> '+v+'</div>'})}
      if(t.imageBriefing)h+='<div style="font-size:11px;margin-top:4px;padding:6px;background:#fff;border-radius:4px;border:1px solid #fde68a">ğŸ¨ '+esc(t.imageBriefing)+'</div>';
      if(t.image)h+='<div style="font-size:11px;color:#166534;font-weight:600;margin-top:4px">âœ“ '+t.imageFile+'</div>';
      else if(ni)h+='<div style="font-size:11px;color:#dc2626;font-weight:600;margin-top:4px">âš  Bild fehlt</div>';
      h+='</div>';
    });
    h+='</div></div>';
  }

  h+='</div>'; // main

  // Generation overlay
  if(s.generating){
    h+='<div class="gen-bg"><div class="gen-box"><div style="padding:20px 20px 12px"><div style="font-size:16px;font-weight:700;margin-bottom:12px">Store wird generiert...</div>';
    s.genSteps.forEach((st,i)=>{
      const cls=i<s.genStep?"done":i===s.genStep?"active":"pending";
      h+='<div class="gen-step '+cls+'"><span style="font-size:14px;width:20px;text-align:center">'+(i<s.genStep?"âœ…":i===s.genStep?"â³":"â¬œ")+'</span><div><div style="font-weight:600">'+st.name+'</div><div style="font-weight:400;opacity:.7">'+st.desc+'</div></div></div>';
    });
    h+='</div><div class="gen-log">';
    s.genLog.forEach(l=>{h+='<div'+(l.includes("âŒ")?' class="err"':"")+'>'+esc(l)+'</div>'});
    h+='<div>_</div></div></div></div>';
  }

  // Error panel
  if(s.showErrors&&!s.generating&&s.errorLog.length){
    h+='<div class="err-panel" onclick="state.showErrors=false;render()"><div class="err-box" onclick="event.stopPropagation()"><div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center"><div style="font-size:16px;font-weight:700;color:#dc2626">ğŸ› Error Log ('+s.errorLog.length+')</div><div style="display:flex;gap:8px"><button style="padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;background:#f3f4f6;border:1px solid #ddd" onclick="state.errorLog=[];state.showErrors=false;render()">Clear</button><button style="padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;background:#f3f4f6;border:1px solid #ddd" onclick="state.showErrors=false;render()">âœ•</button></div></div><div style="flex:1;overflow-y:auto;padding:12px">';
    s.errorLog.forEach(e=>{h+='<div class="err-item"><div class="time">'+e.time+'</div><div class="msg">'+esc(e.msg)+'</div>'+(e.detail?'<pre>'+esc(e.detail)+'</pre>':'')+'</div>'});
    h+='</div></div></div>';
  }

  // Toast
  if(s.toast)h+='<div class="toast '+(s.toast.t==="err"?"err":"ok")+'">'+(s.toast.t==="ok"?"âœ“":"âœ•")+' '+esc(s.toast.m)+'</div>';

  document.getElementById("app").innerHTML=h;
}

// â”€â”€ Tile inner render â”€â”€
function renderTileInner(t,def,c){
  if(t.type==="text")return'<div class="tile-text"><p style="font-size:14px;color:#6b7280;line-height:1.6">'+(esc(c.text)||"Text...")+'</p></div>';
  if(t.type==="image_with_text")return'<div style="display:flex;flex-direction:'+(c.layout==="text_beside"?"row":"column")+';min-height:180px"><div style="flex:1;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#d1d5db;font-size:30px;min-height:140px">'+(t.image?'<img src="'+t.image+'" style="width:100%;height:auto">':"ğŸ–¼ï¸")+'</div><div style="flex:1;padding:20px;display:flex;flex-direction:column;justify-content:center">'+(c.headline?'<h3 style="font-weight:700;font-size:16px;margin-bottom:8px">'+esc(c.headline)+'</h3>':'')+(c.body?'<p style="font-size:14px;color:#6b7280;line-height:1.6">'+esc(c.body)+'</p>':'')+(c.linkText?'<span style="font-size:14px;font-weight:600;margin-top:8px;color:#007EB9">'+esc(c.linkText)+' â†’</span>':'')+'</div></div>';
  if(t.type==="product_grid")return'<div class="tile-product"><div style="font-size:14px;font-weight:600;margin-bottom:8px">Product Grid</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">'+"ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦".split("").slice(0,8).map(()=>'<div style="background:#fafafa;border:1px solid #eee;border-radius:6px;padding:12px;text-align:center">ğŸ“¦</div>').join("")+'</div></div>';
  if(t.type==="best_sellers")return'<div class="tile-auto" style="background:linear-gradient(to right,#fffbeb,#fff7ed)">ğŸ†<div style="font-size:14px;font-weight:600;margin-top:4px">Best Sellers</div></div>';
  if(t.type==="recommended")return'<div class="tile-auto" style="background:#eff6ff">ğŸ’¡<div style="font-size:14px;font-weight:600;margin-top:4px">Recommended</div></div>';
  if(t.type==="featured_deals")return'<div class="tile-auto" style="background:#fff7ed">ğŸ·ï¸<div style="font-size:14px;font-weight:600;margin-top:4px">Featured Deals</div></div>';
  if(t.type==="product")return'<div style="padding:16px;display:flex;align-items:center;gap:12px"><div style="width:64px;height:64px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“¦</div><div><div style="font-weight:600;font-size:14px">'+(esc(c.customTitle||c.name)||"Produkt")+'</div><div style="font-size:11px;color:#9ca3af;font-family:monospace;margin-top:2px">'+(c.asin||"ASIN")+'</div></div></div>';
  if(t.type==="gallery")return'<div style="padding:16px"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">'+"1234".split("").map(()=>'<div style="aspect-ratio:1;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#d1d5db;font-size:20px">ğŸ–¼ï¸</div>').join("")+'</div></div>';
  if(t.type==="video"||t.type==="background_video")return'<div style="display:flex;align-items:center;justify-content:center;padding:32px;font-size:36px;background:#1a1a2e;min-height:160px;color:rgba(255,255,255,.3)">â–¶</div>';
  if(t.type==="shoppable_image")return t.image?'<div style="position:relative"><img src="'+t.image+'" style="width:100%;height:auto"><div style="position:absolute;top:8px;right:8px;padding:2px 8px;background:rgba(255,255,255,.9);border-radius:6px;font-size:12px;font-weight:600">ğŸ›’</div></div>':'<div class="tile-ph"><span class="emoji">ğŸ›’ğŸ–¼ï¸</span><div class="label">Shoppable Image</div></div>';
  // Default image tile
  return t.image?'<img src="'+t.image+'" style="width:100%;height:auto;display:block">':'<div class="tile-ph"><span class="emoji">ğŸ–¼ï¸</span><div class="label">'+def.name+'</div>'+(t.imageBriefing?'<div class="brief">"'+esc(t.imageBriefing).slice(0,80)+'..."</div>':'')+'</div>';
}

// â”€â”€ Field helpers â”€â”€
function inpField(label,path,val){return'<div class="field"><label>'+label+'</label><input value="'+esc(val||"")+'" oninput="setTileProp(\''+path+'\',this.value)"></div>'}
function txtField(label,path,val){return'<div class="field"><label>'+label+'</label><textarea oninput="setTileProp(\''+path+'\',this.value)">'+esc(val||"")+'</textarea></div>'}
function selField(label,path,opts,val){return'<div class="field"><label>'+label+'</label><select onchange="setTileProp(\''+path+'\',this.value)">'+opts.map(([v,l])=>'<option value="'+v+'"'+(val===v?' selected':'')+'>'+l+'</option>').join("")+'</select></div>'}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}

// â”€â”€ Actions â”€â”€
function addTile(type){const t=mkTile(type);curPage().tiles.push(t);state.selTile=t.id;render()}
function delTile(id){const p=curPage();p.tiles=p.tiles.filter(t=>t.id!==id);if(state.selTile===id)state.selTile=null;render()}
function moveTile(id,d){const p=curPage(),ts=p.tiles,i=ts.findIndex(t=>t.id===id),j=i+d;if(j>=0&&j<ts.length)[ts[i],ts[j]]=[ts[j],ts[i]];render()}
function addPage(){const n=prompt("Seitenname:");if(n){const p=mkPage(n);state.store.pages.push(p);state.curPage=p.id;state.selTile=null;render()}}
function delPage(id){if(state.store.pages.length<=1)return;state.store.pages=state.store.pages.filter(p=>p.id!==id);if(state.curPage===id)state.curPage=state.store.pages[0]?.id;render()}
function setTileProp(path,val){
  const t=curTile();if(!t)return;
  if(path==="size"){t.size=val}
  else if(path==="imageBriefing"){t.imageBriefing=val}
  else if(path==="content.asins"){t.content.asins=val.split("\n").filter(Boolean)}
  else if(path.startsWith("content.")){const k=path.split(".")[1];t.content[k]=val}
  render();
}
function doRefineFromInput(){const el=document.getElementById("refine-input");if(el){doRefine(el.value);el.value=""}}

// â”€â”€ Gen modal â”€â”€
function showGenModal(){
  const d=document.createElement("div");d.className="modal-bg";d.onclick=e=>{if(e.target===d)d.remove()};
  d.innerHTML='<div class="modal"><div style="padding:20px 20px 8px"><h2>âœ¨ Multi-Step AI Generator</h2><p>Recherche â†’ Architektur â†’ Content â†’ Validierung</p></div><div style="padding:20px;padding-top:8px;display:flex;flex-direction:column;gap:10px"><div class="field"><label>Markenname *</label><input id="gen-brand" placeholder="z.B. natural elements, HOLY, KÃ¤rcher..."></div><div class="field"><label>Marktplatz</label><select id="gen-mp"><option value="de">ğŸ‡©ğŸ‡ª Amazon.de</option><option value="com">ğŸ‡ºğŸ‡¸ Amazon.com</option><option value="co.uk">ğŸ‡¬ğŸ‡§ Amazon.co.uk</option><option value="fr">ğŸ‡«ğŸ‡· Amazon.fr</option></select></div><div class="field"><label>Kategorie (optional)</label><input id="gen-cat"></div><div class="field"><label>ZusÃ¤tzliche Infos (optional)</label><textarea id="gen-info" rows="2"></textarea></div></div><div style="padding:20px;padding-top:4px;display:flex;justify-content:flex-end;gap:8px"><button class="btn-out" onclick="this.closest(\'.modal-bg\').remove()">Abbrechen</button><button class="btn" onclick="startGen()">ğŸš€ Generieren</button></div></div>';
  document.body.appendChild(d);
}
function startGen(){
  const b=document.getElementById("gen-brand").value;
  const m=document.getElementById("gen-mp").value;
  const c=document.getElementById("gen-cat").value;
  const i=document.getElementById("gen-info").value;
  document.querySelector(".modal-bg")?.remove();
  generate(b,m,c,i);
}

// Initial render
render();
if(!apiKey)setTimeout(()=>{promptKey()},500);
</script>
</body>
</html>
